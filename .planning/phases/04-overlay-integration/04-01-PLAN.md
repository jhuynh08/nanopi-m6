---
phase: 04-overlay-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/ci.yaml
autonomous: true
user_setup:
  - service: dockerhub
    why: "Push overlay images to Docker Hub registry"
    env_vars:
      - name: DOCKERHUB_USERNAME
        source: "GitHub repo settings -> Variables -> Repository variables -> New variable"
        value: "123417"
      - name: DOCKERHUB_TOKEN
        source: "Docker Hub -> Account Settings -> Security -> Access Tokens -> Generate"
    dashboard_config:
      - task: "Create access token with Read/Write permissions"
        location: "https://hub.docker.com/settings/security"

must_haves:
  truths:
    - "CI workflow triggers only on version tags matching v*-nanopi-m6 pattern"
    - "CI workflow authenticates to Docker Hub before push"
    - "CI workflow builds and pushes nanopi-m6 overlay to Docker Hub"
    - "CI workflow generates raw image for nanopi-m6"
  artifacts:
    - path: ".github/workflows/ci.yaml"
      provides: "Modified CI workflow with Docker Hub support and nanopi-m6 board"
      contains: "docker.io/123417/talos-sbc-nanopi-m6"
  key_links:
    - from: ".github/workflows/ci.yaml (sbc-rk3588 job)"
      to: "Docker Hub overlay image"
      via: "crane push after GHCR push"
      pattern: "crane push.*docker.io.*talos-sbc-nanopi-m6"
    - from: ".github/workflows/ci.yaml (boards job)"
      to: "Docker Hub overlay image"
      via: "--overlay-image flag in imager command"
      pattern: "overlay-image=docker.io.*talos-sbc-nanopi-m6"
---

<objective>
Adapt CI workflow to build NanoPi M6 overlay and push to Docker Hub on version tag push.

Purpose: Enable automated image generation via CI/CD instead of local Talos imager setup. This is the foundation for producing bootable raw images.

Output: Modified .github/workflows/ci.yaml with Docker Hub authentication, nanopi-m6 in board matrix, and tag-only trigger.
</objective>

<execution_context>
@/Users/johnsonhuynh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johnsonhuynh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-overlay-integration/04-CONTEXT.md
@.planning/phases/04-overlay-integration/04-RESEARCH.md
@.github/workflows/ci.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Docker Hub authentication and overlay push to sbc-rk3588 job</name>
  <files>.github/workflows/ci.yaml</files>
  <action>
Add Docker Hub login step to the sbc-rk3588 job after the existing GHCR login step.

Add new env vars at the workflow level:
```yaml
DOCKERHUB_USERNAME: ${{ vars.DOCKERHUB_USERNAME }}
DOCKERHUB_REGISTRY: docker.io
```

Add login step after the GHCR login:
```yaml
- name: Login to Docker Hub
  if: github.event_name != 'pull_request'
  uses: docker/login-action@v3
  with:
    registry: docker.io
    username: ${{ vars.DOCKERHUB_USERNAME }}
    password: ${{ secrets.DOCKERHUB_TOKEN }}
```

CRITICAL: Add a step to push the overlay image to Docker Hub AFTER the existing "Push RK3588 overlay to registry" step (which pushes to GHCR). This ensures the overlay is available on Docker Hub for the boards job to consume:
```yaml
- name: Push RK3588 overlay to Docker Hub (for nanopi-m6)
  if: github.event_name != 'pull_request'
  run: |
    crane push _out/talos-sbc-rk3588-${{ matrix.kernel }}.tar docker.io/${{ vars.DOCKERHUB_USERNAME }}/talos-sbc-nanopi-m6:${{ steps.build-overlay.outputs.SBC_RK3588_TAG }}
```

Note: The overlay artifact is the same as pushed to GHCR (talos-sbc-rk3588), but we push it to Docker Hub with the nanopi-m6 name since that's what the user's CONTEXT.md specifies for the image naming.

Keep the existing GHCR login and push for backward compatibility with existing boards.
  </action>
  <verify>
1. Workflow YAML is valid: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yaml'))"`
2. Docker Hub overlay push step exists: `grep -A3 'Push RK3588 overlay to Docker Hub' .github/workflows/ci.yaml`
  </verify>
  <done>Docker Hub login step added to sbc-rk3588 job, overlay push to Docker Hub added after GHCR push</done>
</task>

<task type="auto">
  <name>Task 2: Add nanopi-m6 to board matrix and configure Docker Hub usage</name>
  <files>.github/workflows/ci.yaml</files>
  <action>
In the `boards` job matrix, add nanopi-m6:
```yaml
board:
  - name: rock-5a
    chipset: rk3588s
  - name: rock-5b
    chipset: rk3588
  - name: nanopi-m6
    chipset: rk3588s
    registry: dockerhub  # Flag to indicate Docker Hub for this board
```

Add conditional logic in the "Push installer image" and "Build flashable image" steps to use Docker Hub for nanopi-m6:

For nanopi-m6 only, modify the push step to use Docker Hub:
```yaml
- name: Push installer image to Docker Hub (nanopi-m6)
  if: github.event_name != 'pull_request' && matrix.board.name == 'nanopi-m6'
  run: |
    echo "${{ secrets.DOCKERHUB_TOKEN }}" | crane auth login docker.io --username "${{ vars.DOCKERHUB_USERNAME }}" --password-stdin
    crane push _out/installer-arm64.tar docker.io/${{ vars.DOCKERHUB_USERNAME }}/talos-sbc-nanopi-m6:${{ env.SBC_RK3588_TAG }}-${{ matrix.kernel }}
```

For the flashable image step, use Docker Hub overlay image for nanopi-m6:
```yaml
- name: Build flashable image
  if: startsWith(github.ref, 'refs/tags/')
  run: |
    OVERLAY_REGISTRY="${{ matrix.board.registry == 'dockerhub' && 'docker.io/' || 'ghcr.io/' }}"
    OVERLAY_REPO="${{ matrix.board.registry == 'dockerhub' && vars.DOCKERHUB_USERNAME || env.USERNAME }}"
    OVERLAY_NAME="${{ matrix.board.registry == 'dockerhub' && 'talos-sbc-nanopi-m6' || format('talos-sbc-rk3588-{0}', matrix.kernel) }}"
    docker run --rm -t -v ./_out:/out -v /dev:/dev --privileged ghcr.io/${{ env.USERNAME }}/imager:${{ env.SBC_RK3588_TAG }}-${{ matrix.kernel }} \
    metal --arch arm64 \
      --overlay-image=${OVERLAY_REGISTRY}${OVERLAY_REPO}/${OVERLAY_NAME}:${{ env.SBC_RK3588_TAG }} \
      --overlay-name=rk3588 \
      --overlay-option="board=${{ matrix.board.name }}" \
      --overlay-option="chipset=${{ matrix.board.chipset }}" \
      --base-installer-image="ghcr.io/${{ env.USERNAME }}/talos-rk3588:${{ env.SBC_RK3588_TAG }}-${{ matrix.board.name }}-${{ matrix.kernel }}"
```

IMPORTANT: Keep all existing GHCR logic intact for rock-5a and rock-5b boards. Only nanopi-m6 uses Docker Hub.
  </action>
  <verify>
1. YAML valid: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yaml'))"`
2. nanopi-m6 in matrix: `grep -A2 'nanopi-m6' .github/workflows/ci.yaml`
3. Docker Hub overlay reference: `grep 'docker.io.*talos-sbc-nanopi-m6' .github/workflows/ci.yaml`
  </verify>
  <done>nanopi-m6 added to board matrix with Docker Hub configuration, existing boards unchanged</done>
</task>

<task type="auto">
  <name>Task 3: Configure tag-only trigger for nanopi-m6 builds</name>
  <files>.github/workflows/ci.yaml</files>
  <action>
The existing workflow already triggers on tags (`tags: - v*`). This is sufficient since we'll push tags like `v1.10.6-nanopi-m6`.

However, add a job-level condition to the `boards` job to skip nanopi-m6 builds on non-tag events (it already has `if: startsWith(github.ref, 'refs/tags/')` which is correct).

No changes needed to trigger configuration - the existing `v*` tag pattern covers our `v1.10.6-nanopi-m6` tags.

Verify the workflow structure is correct by reading the final file and confirming:
1. Tags trigger exists: `tags: - v*`
2. Boards job has tag condition: `if: startsWith(github.ref, 'refs/tags/')`
3. nanopi-m6 is in the board matrix

Add a cleanup step specific to Docker Hub logout for nanopi-m6:
```yaml
- name: Cleanup
  if: always()
  continue-on-error: true
  run: |
    crane auth logout ghcr.io
    ${{ matrix.board.registry == 'dockerhub' && 'crane auth logout docker.io' || '' }}
    docker run --rm -t -v ./_out:/out alpine sh -c 'rm -rf /out/*'
```
  </action>
  <verify>
1. Tag trigger: `grep -A2 'tags:' .github/workflows/ci.yaml | head -5`
2. Boards job condition: `grep 'refs/tags' .github/workflows/ci.yaml`
3. Full YAML validation: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yaml'))"`
  </verify>
  <done>Tag-only trigger verified, cleanup updated for Docker Hub logout</done>
</task>

</tasks>

<verification>
1. `.github/workflows/ci.yaml` is valid YAML
2. Docker Hub login step present in sbc-rk3588 job
3. Docker Hub overlay push step present in sbc-rk3588 job (CRITICAL - this is the key link)
4. nanopi-m6 in board matrix with chipset rk3588s
5. Docker Hub overlay image reference in boards job for nanopi-m6
6. Existing rock-5a/rock-5b GHCR logic unchanged
7. Tag trigger pattern supports v*-nanopi-m6 format
</verification>

<success_criteria>
- CI workflow YAML passes validation
- nanopi-m6 board added to matrix
- Docker Hub authentication configured
- sbc-rk3588 job pushes overlay to docker.io/123417/talos-sbc-nanopi-m6 (KEY LINK)
- boards job uses docker.io/123417/talos-sbc-nanopi-m6 as overlay for nanopi-m6
- Workflow will generate talos-*-nanopi-m6-*.raw.xz on tag push
</success_criteria>

<output>
After completion, create `.planning/phases/04-overlay-integration/04-01-SUMMARY.md`
</output>
