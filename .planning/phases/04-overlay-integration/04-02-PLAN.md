---
phase: 04-overlay-integration
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified: []
autonomous: true

must_haves:
  truths:
    - "Version tag pushed to repository triggers CI workflow"
    - "CI workflow completes successfully"
    - "Overlay image published to Docker Hub at docker.io/123417/talos-sbc-nanopi-m6"
    - "Raw image artifact attached to GitHub release"
  artifacts:
    - path: "GitHub Release"
      provides: "talos-*-nanopi-m6-*.raw.xz downloadable artifact"
  key_links:
    - from: "git tag v1.10.6-nanopi-m6"
      to: "GitHub Actions workflow"
      via: "push event on refs/tags/v*"
    - from: "CI workflow"
      to: "docker.io/123417/talos-sbc-nanopi-m6"
      via: "crane push"
---

<objective>
Push version tag to trigger CI workflow, monitor completion, and verify raw image generation.

Purpose: Execute the CI pipeline configured in Plan 01 to produce the actual bootable raw image. This is the critical path from code to hardware.

Output: Version tag pushed, CI workflow completed, raw image available for download from GitHub releases.
</objective>

<execution_context>
@/Users/johnsonhuynh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johnsonhuynh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-overlay-integration/04-CONTEXT.md
@.planning/phases/04-overlay-integration/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create and push version tag</name>
  <files></files>
  <action>
Create an annotated tag matching the Talos version being used (v1.10.6) with the nanopi-m6 suffix:

```bash
git tag -a v1.10.6-nanopi-m6 -m "NanoPi M6 overlay for Talos v1.10.6

- Vendor U-Boot (FriendlyELEC idbloader.img + uboot.img)
- Vendor DTB (rk3588s-nanopi-m6.dtb)
- RK3588 installer with nanopi-m6 support"

git push origin v1.10.6-nanopi-m6
```

IMPORTANT: This must be done manually by the user or with a PAT, not GITHUB_TOKEN, because:
1. Tags pushed with GITHUB_TOKEN do not trigger workflows (GitHub security design)
2. The user needs to push the tag from their authenticated git session

If git push fails with auth error, this is expected - the user must push manually.
  </action>
  <verify>
1. Tag exists locally: `git tag -l 'v1.10.6-nanopi-m6'`
2. Tag pushed to remote: `git ls-remote --tags origin | grep 'v1.10.6-nanopi-m6'`
  </verify>
  <done>Tag v1.10.6-nanopi-m6 created and pushed to origin</done>
</task>

<task type="auto">
  <name>Task 2: Monitor CI workflow execution</name>
  <files></files>
  <action>
Use GitHub CLI to monitor the workflow triggered by the tag push:

```bash
# List workflow runs for the tag
gh run list --branch v1.10.6-nanopi-m6 --limit 5

# Watch the workflow run (get run ID from above)
gh run watch <RUN_ID>

# Or check status
gh run view <RUN_ID>
```

Expected workflow jobs:
1. `sbc-rk3588` - Builds overlay (bsp and mainline kernel variants)
2. `boards` - Builds installer and flashable images for each board (including nanopi-m6)
3. `release` - Creates GitHub release with raw image artifacts

Monitor for:
- Build overlay success
- Docker Hub push success (for nanopi-m6)
- Raw image generation success
- Release creation

If workflow fails, check logs:
```bash
gh run view <RUN_ID> --log-failed
```
  </action>
  <verify>
1. Workflow completed: `gh run list --branch v1.10.6-nanopi-m6 --status completed`
2. All jobs succeeded: `gh run view <RUN_ID> --json jobs --jq '.jobs[] | select(.conclusion != "success")'` returns empty
  </verify>
  <done>CI workflow completed successfully with all jobs passing</done>
</task>

<task type="auto">
  <name>Task 3: Verify artifacts and download raw image</name>
  <files></files>
  <action>
Verify the release was created and contains the nanopi-m6 raw image:

```bash
# List releases
gh release list --limit 5

# View release assets
gh release view v1.10.6-nanopi-m6

# Download the nanopi-m6 raw image (mainline kernel)
gh release download v1.10.6-nanopi-m6 --pattern '*nanopi-m6-mainline*.raw.xz' --dir ./_out/
```

Expected artifact naming: `talos-v1.10.6-nanopi-m6-mainline.raw.xz`

Also verify Docker Hub image was pushed:
```bash
# Check Docker Hub (no auth needed for public image check)
docker manifest inspect docker.io/123417/talos-sbc-nanopi-m6:v1.10.6-nanopi-m6 2>/dev/null && echo "Image exists" || echo "Image not found"
```

If the Docker Hub image exists but release download fails, the release job may have failed independently. Check the release job logs.
  </action>
  <verify>
1. Release exists: `gh release view v1.10.6-nanopi-m6`
2. Raw image downloaded: `ls -la _out/talos-*-nanopi-m6-*.raw.xz`
3. File size reasonable (>500MB compressed): `du -h _out/talos-*-nanopi-m6-*.raw.xz`
  </verify>
  <done>Raw image downloaded to _out/, ready for flashing</done>
</task>

</tasks>

<verification>
1. Tag v1.10.6-nanopi-m6 exists on remote
2. CI workflow completed successfully
3. GitHub release v1.10.6-nanopi-m6 created
4. Raw image artifact (talos-*-nanopi-m6-*.raw.xz) downloadable
5. Docker Hub image docker.io/123417/talos-sbc-nanopi-m6 accessible
</verification>

<success_criteria>
- Version tag pushed and visible on GitHub
- CI workflow runs triggered automatically
- All workflow jobs complete successfully
- Release created with raw image artifact
- Raw image downloaded locally for boot testing
</success_criteria>

<output>
After completion, create `.planning/phases/04-overlay-integration/04-02-SUMMARY.md`
</output>
