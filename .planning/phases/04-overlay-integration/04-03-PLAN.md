---
phase: 04-overlay-integration
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Raw image flashed to SD card successfully"
    - "NanoPi M6 boots to Talos maintenance mode"
    - "Ethernet interface (eth0) appears in ip link output"
    - "NVMe device (/dev/nvme0n1) detected"
    - "Board identified as nanopi-m6 in device tree"
  artifacts: []
  key_links:
    - from: "SD card"
      to: "NanoPi M6 hardware"
      via: "Physical boot from SD slot"
    - from: "Talos maintenance mode"
      to: "Hardware drivers"
      via: "Kernel module loading"
---

<objective>
Flash raw image to SD card, boot NanoPi M6 to Talos maintenance mode, and validate hardware detection.

Purpose: Prove the complete overlay integration works end-to-end by booting real hardware. This completes both OVRL-04 (bootable image) and the deferred Phase 3 hardware validation.

Output: NanoPi M6 running Talos in maintenance mode with Ethernet and NVMe detected (blocking), USB enumerated (non-blocking).
</objective>

<execution_context>
@/Users/johnsonhuynh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johnsonhuynh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-overlay-integration/04-CONTEXT.md
@.planning/phases/04-overlay-integration/04-02-SUMMARY.md
@.planning/phases/03-device-tree-kernel/03-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Decompress and flash raw image to SD card</name>
  <files></files>
  <action>
Decompress the raw image and flash to SD card. The image is already compressed with xz.

On macOS:
```bash
# Find the SD card device
diskutil list

# Unmount (but don't eject) the SD card - example /dev/disk4
diskutil unmountDisk /dev/disk4

# Decompress and flash using raw device for speed (rdisk)
xz -dk _out/talos-*-nanopi-m6-mainline.raw.xz
sudo dd if=_out/talos-*-nanopi-m6-mainline.raw of=/dev/rdisk4 bs=4M status=progress

# Sync and eject
sync
diskutil eject /dev/disk4
```

IMPORTANT:
- Use the CORRECT disk device (verify with `diskutil list`)
- Use `rdisk` (raw device) not `disk` for 5-10x faster writes
- The raw image is ~1.3GB, flash takes ~2-3 minutes with rdisk

Alternative one-liner (decompress and flash in pipeline):
```bash
xzcat _out/talos-*-nanopi-m6-mainline.raw.xz | sudo dd of=/dev/rdisk4 bs=4M status=progress
```
  </action>
  <verify>
1. Raw image decompressed: `ls -la _out/talos-*-nanopi-m6-mainline.raw`
2. Flash completed without errors (check dd exit code)
3. SD card ejected cleanly
  </verify>
  <done>Raw image flashed to SD card, card ejected and ready for boot</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Boot and verify Talos maintenance mode</name>
  <what-built>
Talos Linux raw image for NanoPi M6 with:
- Vendor U-Boot (FriendlyELEC idbloader.img + uboot.img)
- Vendor DTB (rk3588s-nanopi-m6.dtb)
- Talos Linux v1.10.6 root filesystem
  </what-built>
  <how-to-verify>
1. Insert SD card into NanoPi M6
2. Connect HDMI monitor
3. Connect power
4. Observe boot sequence on HDMI:
   - U-Boot banner should appear first
   - Linux kernel boot messages
   - Talos maintenance mode prompt

Expected on screen:
```
Talos Linux

This machine is not configured. Apply a machine configuration to begin.

Waiting for network...
```

If boot fails (no output, stuck at U-Boot, kernel panic):
- Note the last visible message
- Power cycle and try again
- If persistent failure, report the error for debugging

IMPORTANT: Talos maintenance mode is expected because no machine config has been applied yet. This is SUCCESS for this phase.
  </how-to-verify>
  <resume-signal>
Type one of:
- "booted" - Talos maintenance mode visible on HDMI
- "u-boot only" - Stuck at U-Boot, describe last message
- "no output" - No HDMI signal at all
- "kernel panic" - Include panic message
  </resume-signal>
</task>

<task type="auto">
  <name>Task 3: Validate hardware detection (Ethernet, NVMe, USB, board ID)</name>
  <files></files>
  <action>
Once Talos maintenance mode is confirmed, validate hardware detection from the console.

In Talos maintenance mode, you can use the built-in diagnostic commands or connect via serial/SSH if network is up.

From HDMI console (if available) or serial console:

**Ethernet (BLOCKING if fails):**
```bash
ip link | grep eth0
# Expected: eth0 interface listed (may show "NO-CARRIER" if no cable)
```

**NVMe (BLOCKING if fails):**
```bash
ls -la /dev/nvme*
# Expected: /dev/nvme0n1 (and possibly nvme0n1p* partitions if data exists)
```

**USB (non-blocking):**
```bash
lsusb
# Expected: At least USB hub and any connected devices
```

**Board Identification:**
```bash
cat /proc/device-tree/compatible
# Expected: Contains "friendlyelec,nanopi-m6" and "rockchip,rk3588"
```

If Ethernet is up and has connectivity, you can also use talosctl:
```bash
talosctl -n <IP> get members
```

Record results for each check:
- Ethernet: PASS/FAIL (interface present?)
- NVMe: PASS/FAIL (device detected?)
- USB: PASS/FAIL/SKIP (enumeration works?)
- Board ID: PASS/FAIL (correct compatible string?)
  </action>
  <verify>
1. Ethernet: `ip link` shows eth0
2. NVMe: `/dev/nvme0n1` exists
3. USB: `lsusb` returns results (non-blocking)
4. Board ID: `/proc/device-tree/compatible` contains nanopi-m6
  </verify>
  <done>Hardware validation complete: Ethernet PASS, NVMe PASS, USB [result], Board ID PASS</done>
</task>

</tasks>

<verification>
1. Raw image flashed to SD card without errors
2. NanoPi M6 boots to Talos maintenance mode (HDMI output)
3. Ethernet interface eth0 detected (blocking)
4. NVMe device /dev/nvme0n1 detected (blocking)
5. USB enumeration works (non-blocking)
6. Device tree identifies board as nanopi-m6
</verification>

<success_criteria>
- Talos maintenance mode displayed on HDMI (proves OVRL-04)
- Ethernet and NVMe detected (blocking requirements from Phase 3 deferred checks)
- USB status documented (non-blocking)
- Board correctly identified in device tree
</success_criteria>

<output>
After completion, create `.planning/phases/04-overlay-integration/04-03-SUMMARY.md`
</output>
