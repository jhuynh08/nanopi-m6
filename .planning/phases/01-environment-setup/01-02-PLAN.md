---
phase: 01-environment-setup
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - .github/workflows/ci.yaml
  - hack/flash.sh
autonomous: true

user_setup:
  - service: docker-hub
    why: "Container image hosting for overlay builds"
    env_vars:
      - name: DOCKER_USERNAME
        source: "Docker Hub account username"
      - name: DOCKER_TOKEN
        source: "Docker Hub -> Account Settings -> Security -> Access Tokens -> New Access Token"
    dashboard_config:
      - task: "Create access token with Read/Write permissions"
        location: "hub.docker.com -> Account Settings -> Security -> Access Tokens"

must_haves:
  truths:
    - "Docker buildx can build ARM64 images on local machine"
    - "Local build produces overlay artifacts in _out/"
    - "GitHub Actions CI workflow exists and is syntactically valid"
  artifacts:
    - path: "_out/"
      provides: "Build output directory with artifacts"
    - path: ".github/workflows/ci.yaml"
      provides: "GitHub Actions CI configuration"
      contains: "docker/setup-buildx-action"
  key_links:
    - from: "Makefile"
      to: "_out/"
      via: "DEST parameter"
      pattern: "DEST=_out"
    - from: ".github/workflows/ci.yaml"
      to: "Docker Hub"
      via: "docker/login-action"
      pattern: "docker.io"
---

<objective>
Configure and verify the Docker buildx build pipeline for local ARM64 builds and set up GitHub Actions CI.

Purpose: Establishes the ability to build Talos SBC overlay artifacts both locally (for rapid iteration) and in CI (for releases and validation). Without working builds, no images can be created.

Output: Working local build producing artifacts, plus CI workflow ready for execution on push.
</objective>

<execution_context>
@/Users/johnsonhuynh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johnsonhuynh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-environment-setup/01-CONTEXT.md
@.planning/phases/01-environment-setup/01-RESEARCH.md
@.planning/phases/01-environment-setup/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify Docker buildx ARM64 capability</name>
  <files>None (verification only)</files>
  <action>
Verify Docker Desktop is configured for ARM64 builds on Apple Silicon:

1. Check Docker is running:
   ```bash
   docker version
   ```

2. List available buildx builders:
   ```bash
   docker buildx ls
   ```
   Expected: Should see a builder with linux/arm64 in platforms

3. Inspect the default builder:
   ```bash
   docker buildx inspect --bootstrap
   ```
   Expected: Platforms should include linux/arm64

4. If ARM64 not available (unlikely on Apple Silicon), create a builder:
   ```bash
   docker buildx create --name sbc-builder --driver docker-container --use
   docker buildx inspect --bootstrap
   ```

5. Verify Docker Desktop has sufficient resources:
   - Memory: Recommend 8GB minimum for kernel builds
   - Note: Cannot check programmatically, but document the recommendation

Document findings for the summary.
  </action>
  <verify>
- `docker buildx ls` shows builder with linux/arm64 platform
- `docker buildx inspect --bootstrap` completes without error
  </verify>
  <done>Docker buildx confirmed capable of ARM64 builds</done>
</task>

<task type="auto">
  <name>Task 2: Run local overlay build</name>
  <files>_out/</files>
  <action>
Execute a local build to verify the build pipeline works:

1. First, regenerate Makefile if needed (kres):
   ```bash
   # Check if make target exists
   make help 2>/dev/null | grep -q "local-" || make rekres
   ```

2. Run the local build targeting _out/:
   ```bash
   make local-talos-sbc-rk3588-mainline DEST=_out
   ```

   If the exact target name differs, check available targets:
   ```bash
   make help | grep local
   ```

3. Verify build outputs exist:
   ```bash
   ls -la _out/
   ```
   Expected: Directory should contain build artifacts (exact files depend on what the overlay produces)

4. If build fails, capture the error and document:
   - Check if dependencies are missing
   - Verify Docker has enough resources (increase memory if OOM)
   - Note any fixes applied

Note: First build may take 15-30 minutes depending on caching.
  </action>
  <verify>
- `ls _out/` shows build artifacts (files present, not empty)
- Build command exits with status 0
  </verify>
  <done>Local build produces artifacts in _out/ directory</done>
</task>

<task type="auto">
  <name>Task 3: Configure GitHub Actions CI</name>
  <files>.github/workflows/ci.yaml</files>
  <action>
Create GitHub Actions workflow for CI builds:

1. Create the workflow file at `.github/workflows/ci.yaml`:

```yaml
name: CI

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

env:
  REGISTRY: docker.io

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ vars.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build overlay
        run: |
          make docker-talos-sbc-rk3588-mainline \
            REGISTRY=${{ env.REGISTRY }} \
            USERNAME=${{ vars.DOCKER_USERNAME || 'test' }} \
            PUSH=${{ github.event_name != 'pull_request' && vars.DOCKER_USERNAME != '' }}

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: _out/
          if-no-files-found: ignore
          retention-days: 7
```

2. Create directory if needed:
   ```bash
   mkdir -p .github/workflows
   ```

3. Validate YAML syntax:
   ```bash
   # Use Python for YAML validation
   python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yaml'))" && echo "YAML valid"
   ```

4. Commit the workflow:
   ```bash
   git add .github/workflows/ci.yaml
   git commit -m "ci: add GitHub Actions workflow for overlay builds"
   git push origin main
   ```

Note: CI won't fully work until DOCKER_USERNAME variable and DOCKER_TOKEN secret are configured in GitHub repo settings. The workflow is designed to build without pushing on PRs and when credentials aren't set.
  </action>
  <verify>
- `.github/workflows/ci.yaml` exists and is valid YAML
- `git log --oneline -1` shows CI commit
- `gh workflow list` shows the CI workflow (after push)
  </verify>
  <done>GitHub Actions CI workflow configured and pushed</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `docker buildx ls` shows ARM64-capable builder
2. `ls _out/` contains build artifacts from local build
3. `.github/workflows/ci.yaml` exists with valid configuration
4. `gh workflow list` shows CI workflow available
</verification>

<success_criteria>
- Docker buildx confirmed ARM64-capable on local machine
- Local build completes successfully with artifacts in _out/
- GitHub Actions workflow created and pushed
- CI workflow syntactically valid (YAML parses)
</success_criteria>

<output>
After completion, create `.planning/phases/01-environment-setup/01-02-SUMMARY.md`
</output>
