---
phase: 01-environment-setup
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - hack/flash.sh
  - docs/FLASH-WORKFLOW.md
autonomous: false

must_haves:
  truths:
    - "Flash script writes images to SD card safely"
    - "Known-good Armbian image boots on NanoPi M6 hardware"
    - "Verification workflow documented for non-UART debugging"
  artifacts:
    - path: "hack/flash.sh"
      provides: "SD card flashing script"
      contains: "diskutil"
    - path: "docs/FLASH-WORKFLOW.md"
      provides: "Flash and verification documentation"
      contains: "LED"
  key_links:
    - from: "hack/flash.sh"
      to: "/dev/rdisk"
      via: "dd command"
      pattern: "dd.*rdisk"
---

<objective>
Create the SD card flash workflow and verify hardware boots with a known-good image.

Purpose: Establishes the ability to test built images on real hardware. Without a verified flash workflow and baseline boot confirmation, we cannot validate any artifacts we build. The Armbian baseline proves the hardware works before we introduce our custom images.

Output: Working flash script, documented verification workflow, and confirmed baseline boot.
</objective>

<execution_context>
@/Users/johnsonhuynh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johnsonhuynh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-environment-setup/01-CONTEXT.md
@.planning/phases/01-environment-setup/01-RESEARCH.md
@.planning/phases/01-environment-setup/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SD card flash script</name>
  <files>hack/flash.sh</files>
  <action>
Create a safe SD card flashing script at `hack/flash.sh`:

```bash
#!/usr/bin/env bash
#
# Flash an image to SD card (macOS)
# Usage: ./hack/flash.sh <image-file> [disk-number]
#
# Example: ./hack/flash.sh _out/metal-arm64.raw 2
#

set -euo pipefail

IMAGE="${1:-}"
DISK_NUM="${2:-}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

error() { echo -e "${RED}ERROR: $*${NC}" >&2; exit 1; }
warn() { echo -e "${YELLOW}WARNING: $*${NC}" >&2; }
info() { echo -e "${GREEN}$*${NC}"; }

# Validate image file
[[ -z "$IMAGE" ]] && error "Usage: $0 <image-file> [disk-number]"
[[ ! -f "$IMAGE" ]] && error "Image file not found: $IMAGE"

# Show available disks
echo "Available disks:"
diskutil list external

# Get or confirm disk number
if [[ -z "$DISK_NUM" ]]; then
    echo ""
    read -p "Enter disk number (e.g., 2 for /dev/disk2): " DISK_NUM
fi

DISK="/dev/disk${DISK_NUM}"
RDISK="/dev/rdisk${DISK_NUM}"

# Verify disk exists
[[ ! -e "$DISK" ]] && error "Disk not found: $DISK"

# Get disk info for confirmation
DISK_SIZE=$(diskutil info "$DISK" | grep "Disk Size" | awk '{print $3, $4}')
DISK_NAME=$(diskutil info "$DISK" | grep "Device / Media Name" | cut -d: -f2 | xargs)

# Safety check: refuse if disk looks like internal
if diskutil info "$DISK" | grep -q "Internal"; then
    error "Refusing to write to internal disk: $DISK"
fi

# Confirm before proceeding
echo ""
echo "================================================"
echo "Target: $DISK ($DISK_SIZE)"
echo "Name: $DISK_NAME"
echo "Image: $IMAGE ($(du -h "$IMAGE" | cut -f1))"
echo "================================================"
echo ""
warn "This will ERASE ALL DATA on $DISK"
read -p "Type 'yes' to continue: " CONFIRM

[[ "$CONFIRM" != "yes" ]] && error "Aborted by user"

# Unmount disk
info "Unmounting $DISK..."
diskutil unmountDisk "$DISK" || warn "Unmount failed, continuing anyway"

# Flash image
info "Flashing image (this may take several minutes)..."
echo "Command: sudo dd if=$IMAGE of=$RDISK bs=1m status=progress"
sudo dd if="$IMAGE" of="$RDISK" bs=1m status=progress

# Sync and eject
info "Syncing..."
sync

info "Ejecting $DISK..."
diskutil eject "$DISK"

info "Done! SD card is ready."
echo ""
echo "Next steps:"
echo "1. Insert SD card into NanoPi M6"
echo "2. Connect HDMI and/or network"
echo "3. Power on and watch for:"
echo "   - LED activity (SYS LED should blink)"
echo "   - HDMI output (U-Boot/kernel messages)"
echo "   - Network (ping after ~60-90 seconds)"
```

Make it executable:
```bash
mkdir -p hack
chmod +x hack/flash.sh
```
  </action>
  <verify>
- `ls -la hack/flash.sh` shows executable file
- `./hack/flash.sh` with no args prints usage and lists external disks
- Script contains safety checks (refuses internal disks, requires confirmation)
  </verify>
  <done>Flash script created with safety checks and user confirmation</done>
</task>

<task type="auto">
  <name>Task 2: Create verification workflow documentation</name>
  <files>docs/FLASH-WORKFLOW.md</files>
  <action>
Create documentation for the flash and verification workflow at `docs/FLASH-WORKFLOW.md`:

```markdown
# Flash and Verification Workflow

This document describes how to flash images to SD card and verify boot on NanoPi M6 hardware.

## Prerequisites

- macOS with SD card reader (or USB adapter)
- microSD card (32GB+ recommended, Samsung EVO or SanDisk Extreme preferred)
- NanoPi M6 board with power supply
- HDMI monitor and/or network connection for verification

## Flashing Images

### Using the Flash Script (Recommended)

```bash
# Flash a built image
./hack/flash.sh _out/metal-arm64.raw

# Or specify disk number directly (skip interactive prompt)
./hack/flash.sh _out/metal-arm64.raw 2
```

The script will:
1. Show available external disks
2. Ask for confirmation before writing
3. Refuse to write to internal disks
4. Use fast raw device (rdisk) for better performance

### Manual Flashing

If you prefer manual steps:

```bash
# 1. List disks to find your SD card
diskutil list external

# 2. Unmount (not eject!) the SD card
diskutil unmountDisk /dev/disk2

# 3. Flash using raw device for speed
sudo dd if=_out/metal-arm64.raw of=/dev/rdisk2 bs=1m status=progress

# 4. Sync and eject
sync
diskutil eject /dev/disk2
```

## Boot Verification (Without UART)

Since we don't have UART initially, use these methods to verify boot:

### 1. LED Indicators

| Time | LED Behavior | Meaning |
|------|-------------|---------|
| 0-5s | SYS LED blinks once | Power on, BL31/SPL starting |
| 5-10s | SYS LED blinking | U-Boot running |
| 10-30s | Rapid LED activity | Kernel booting |
| 30s+ | Steady or periodic blink | System running |

**No LED activity after 10 seconds = bootloader failed**

### 2. HDMI Output

Connect HDMI before powering on. You should see:
- U-Boot logo/text (within 5 seconds)
- Kernel boot messages
- Talos maintenance mode or login prompt

### 3. Network Ping

After ~60-90 seconds:
1. Check router DHCP leases for new device
2. Ping the assigned IP address
3. Try SSH if Talos is running: `talosctl --nodes <ip> version`

## Troubleshooting

### Board appears dead (no LEDs)
- Check power supply (must be 5V 4A minimum for M6)
- Try different power cable
- Verify SD card is fully inserted
- Reflash SD card with known-good image

### LEDs blink but no HDMI
- Kernel/DTB mismatch likely
- U-Boot may be working but kernel fails
- Try different HDMI cable/monitor
- Check if Armbian baseline works

### HDMI shows kernel panic
- Driver or configuration issue
- Note the panic message for debugging
- Try Armbian baseline to isolate issue

### Network not reachable
- Check physical cable connection
- Verify router DHCP is enabled
- May need static IP configuration

## Baseline Testing

Before testing custom images, verify hardware with Armbian:

1. Download Armbian for NanoPi M6 from https://www.armbian.com/nanopi-m6/
2. Flash using the script: `./hack/flash.sh Armbian_*.img`
3. Boot and verify HDMI + network work
4. This proves hardware is functional

If Armbian works but custom image doesn't, the issue is in our image.
If Armbian also fails, the issue is hardware or SD card.
```

Create the docs directory and commit:
```bash
mkdir -p docs
git add hack/flash.sh docs/FLASH-WORKFLOW.md
git commit -m "docs: add flash script and verification workflow"
```
  </action>
  <verify>
- `ls docs/FLASH-WORKFLOW.md` shows file exists
- Documentation covers LED indicators, HDMI, and network verification
- `git log --oneline -1` shows docs commit
  </verify>
  <done>Flash workflow documentation created covering non-UART verification</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify hardware baseline with Armbian</name>
  <what-built>
Flash script and verification workflow documentation. Now we need to verify the actual hardware works before building custom images.
  </what-built>
  <how-to-verify>
**Goal:** Confirm NanoPi M6 hardware boots with a known-good Armbian image.

**Steps:**

1. Download Armbian for NanoPi M6:
   - Visit https://www.armbian.com/nanopi-m6/
   - Download the latest stable image (Bookworm or Jammy)

2. Flash Armbian to SD card:
   ```bash
   ./hack/flash.sh ~/Downloads/Armbian_*.img
   ```

3. Insert SD card into NanoPi M6 and power on

4. Verify boot:
   - [ ] LEDs show activity within 10 seconds
   - [ ] HDMI displays boot messages (if connected)
   - [ ] Can ping device after ~90 seconds (check router for IP)

5. (Optional) SSH into Armbian to fully confirm:
   ```bash
   ssh root@<ip-address>  # Default password: 1234
   ```

**What success looks like:**
- Armbian boots to login prompt (HDMI or SSH)
- Network connectivity works
- Hardware is confirmed functional

**If it fails:**
- Note LED behavior and any HDMI output
- Try a different SD card
- Check power supply (5V 4A required)
  </how-to-verify>
  <resume-signal>
Type "hardware verified" if Armbian boots successfully, or describe the failure observed (LED behavior, HDMI output, etc.)
  </resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. `./hack/flash.sh` runs and shows usage information
2. `docs/FLASH-WORKFLOW.md` exists with complete documentation
3. User has confirmed Armbian boots on the NanoPi M6 hardware
</verification>

<success_criteria>
- Flash script created with safety checks
- Verification workflow documented (LED, HDMI, network methods)
- Hardware baseline confirmed with Armbian boot
- Development environment ready for custom image testing
</success_criteria>

<output>
After completion, create `.planning/phases/01-environment-setup/01-03-SUMMARY.md`
</output>
