---
phase: 02-bootloader
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/ARMBIAN-UBOOT-ANALYSIS.md
  - artifacts/u-boot/nanopi-m6/defconfig.diff
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Armbian NanoPi M6 U-Boot defconfig extracted and documented"
    - "Key differences from rock5a/r6c identified"
    - "DDR timing and board-specific parameters captured"
  artifacts:
    - path: "docs/ARMBIAN-UBOOT-ANALYSIS.md"
      provides: "Analysis of Armbian U-Boot patches for NanoPi M6"
      min_lines: 50
    - path: "artifacts/u-boot/nanopi-m6/defconfig.diff"
      provides: "Diff of M6 defconfig vs rock5a"
      min_lines: 10
  key_links:
    - from: "docs/ARMBIAN-UBOOT-ANALYSIS.md"
      to: "artifacts/u-boot/nanopi-m6/pkg.yaml"
      via: "defconfig path reference"
      pattern: "defconfig|CONFIG_"
---

<objective>
Extract Armbian's NanoPi M6 U-Boot configuration by analyzing their build-system repository. Armbian successfully boots on NanoPi M6 hardware (validated in Phase 1), proving the correct U-Boot configuration exists in their patches.

Purpose: Identify the M6-specific board initialization, DDR training parameters, and defconfig that enables successful boot on NanoPi M6 hardware.

Output: Analysis document and defconfig diff that enables Plan 02-05 to apply corrections to our U-Boot build.
</objective>

<execution_context>
@/Users/johnsonhuynh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johnsonhuynh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-bootloader/02-03-SUMMARY.md
@.planning/phases/02-bootloader/02-VERIFICATION.md

Key context from verification:
- rock5a-rk3588s_defconfig does NOT work for NanoPi M6
- Boot fails at DDR training stage (no LED activity)
- Armbian boots successfully on same hardware
- Need M6-specific: DDR timing, pinmux, GPIO configuration
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract Armbian NanoPi M6 U-Boot Configuration</name>
  <files>docs/ARMBIAN-UBOOT-ANALYSIS.md, artifacts/u-boot/nanopi-m6/defconfig.diff</files>
  <action>
Research Armbian's build-system repository to extract NanoPi M6 U-Boot configuration.

1. Clone or fetch Armbian build repository (armbian/build):
   - Check `config/boards/nanopi-m6.csc` or `.conf` for board config
   - Check `config/sources/families/rk35xx.conf` for family-level config
   - Check `patch/u-boot/` for NanoPi M6 or RK3588S patches

2. Find the U-Boot source and defconfig:
   - Identify which U-Boot fork Armbian uses (may be their own or vendor)
   - Locate defconfig file: likely `nanopi-m6-rk3588s_defconfig` or similar
   - Extract full defconfig content

3. Find DDR and BL31 blob versions:
   - Check which rkbin versions Armbian uses
   - Note any DDR training parameter patches

4. Compare with our rock5a config:
   - Generate diff between rock5a-rk3588s_defconfig and Armbian's M6 config
   - Identify critical differences (DDR timing, UART console, boot device, pinmux)

5. Create analysis document (docs/ARMBIAN-UBOOT-ANALYSIS.md):
   - Document Armbian's U-Boot source location
   - Document defconfig name and key CONFIG options
   - Document any patches applied
   - Document recommended changes for our build

6. Create defconfig diff file (artifacts/u-boot/nanopi-m6/defconfig.diff):
   - Show exact CONFIG_ differences between rock5a and M6
   - Prioritize: DDR config, console UART, boot device order, pinmux

Key sources to check:
- https://github.com/armbian/build
- https://github.com/armbian/community - may have community boards
- FriendlyElec BSP (friendlyarm/kernel-rockchip) may have U-Boot patches

DO NOT:
- Attempt to build Armbian (too heavy for this task)
- Copy entire U-Boot tree (just extract configs)
- Modify our pkg.yaml yet (that's Plan 02-05)
  </action>
  <verify>
- docs/ARMBIAN-UBOOT-ANALYSIS.md exists with >50 lines
- artifacts/u-boot/nanopi-m6/defconfig.diff exists
- Analysis document identifies defconfig source
- Analysis document lists key CONFIG differences
- Document explains DDR/BL31 blob requirements
  </verify>
  <done>
Armbian NanoPi M6 U-Boot configuration fully documented with:
- Source repository and path to defconfig
- Key CONFIG differences from rock5a
- DDR blob requirements (version, timing parameters)
- Recommended changes for our build in Plan 02-05
  </done>
</task>

</tasks>

<verification>
- [ ] docs/ARMBIAN-UBOOT-ANALYSIS.md exists and is substantive (>50 lines)
- [ ] artifacts/u-boot/nanopi-m6/defconfig.diff exists
- [ ] Analysis identifies specific defconfig source (repo + path)
- [ ] Analysis explains why rock5a doesn't work (specific CONFIG differences)
- [ ] Analysis provides clear action items for Plan 02-05
</verification>

<success_criteria>
- Armbian's NanoPi M6 U-Boot configuration extracted and documented
- Key differences from rock5a-rk3588s_defconfig identified
- Clear path forward for updating our pkg.yaml in Plan 02-05
</success_criteria>

<output>
After completion, create `.planning/phases/02-bootloader/02-04-SUMMARY.md`
</output>
