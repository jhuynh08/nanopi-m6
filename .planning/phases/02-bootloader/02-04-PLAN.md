---
phase: 02-bootloader
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/ARMBIAN-UBOOT-ANALYSIS.md
  - artifacts/u-boot/nanopi-m6/defconfig.diff
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Plan 02-05 can apply M6 config without additional research"
    - "Specific CONFIG options to change are listed with exact values"
    - "DDR parameters identified (blob version, timing values if applicable)"
  artifacts:
    - path: "docs/ARMBIAN-UBOOT-ANALYSIS.md"
      provides: "Analysis of Armbian U-Boot patches for NanoPi M6"
      min_lines: 50
      contains: "defconfig"
    - path: "artifacts/u-boot/nanopi-m6/defconfig.diff"
      provides: "Diff of M6 defconfig vs rock5a"
      min_lines: 10
  key_links:
    - from: "docs/ARMBIAN-UBOOT-ANALYSIS.md"
      to: "artifacts/u-boot/nanopi-m6/pkg.yaml"
      via: "defconfig path reference"
      pattern: "defconfig|CONFIG_"
---

<objective>
Extract Armbian's NanoPi M6 U-Boot configuration by analyzing their build-system repository. Armbian successfully boots on NanoPi M6 hardware (validated in Phase 1), proving the correct U-Boot configuration exists in their patches.

Purpose: Identify the M6-specific board initialization, DDR training parameters, and defconfig that enables successful boot on NanoPi M6 hardware.

Output: Analysis document and defconfig diff that enables Plan 02-05 to apply corrections to our U-Boot build.
</objective>

<execution_context>
@/Users/johnsonhuynh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johnsonhuynh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-bootloader/02-03-SUMMARY.md
@.planning/phases/02-bootloader/02-VERIFICATION.md

Key context from verification:
- rock5a-rk3588s_defconfig does NOT work for NanoPi M6
- Boot fails at DDR training stage (no LED activity)
- Armbian boots successfully on same hardware
- Need M6-specific: DDR timing, pinmux, GPIO configuration
</context>

<tasks>

<task type="auto">
  <name>Task 1: Locate NanoPi M6 Config in Armbian</name>
  <files>None (research only)</files>
  <action>
Find the exact location of NanoPi M6 U-Boot configuration in Armbian repositories.

1. Search Armbian build repository (armbian/build) via GitHub web or gh CLI:
   - `config/boards/` for board config files matching `nanopi*m6*`
   - `config/sources/families/` for RK3588 family config
   - `patch/u-boot/` for M6 or RK3588S patches

2. If not in main repo, check:
   - armbian/community repository
   - FriendlyElec BSP (friendlyarm repos on GitHub)

3. Record findings:
   - Repository URL
   - Exact file path to board config
   - Exact file path to defconfig or patches

**Deliverable:** Mental note of repo URL + file path (used in Task 2).

**If config NOT found after checking all sources:**
- Document which repos were searched
- This becomes a blocker requiring escalation

DO NOT:
- Clone full repositories yet (wait for Task 2)
- Start analysis yet (that's Task 2)
  </action>
  <verify>
Can answer: "Armbian M6 config is at [repo]/[path]" OR "Config not found in [list of repos searched]"
  </verify>
  <done>
Location of Armbian NanoPi M6 U-Boot config identified (repo + path), ready for extraction in Task 2.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract and Analyze M6 Configuration</name>
  <files>docs/ARMBIAN-UBOOT-ANALYSIS.md, artifacts/u-boot/nanopi-m6/defconfig.diff</files>
  <action>
Extract and analyze the M6 config found in Task 1.

1. Fetch the relevant files (sparse checkout or direct download):
   - Board config file (e.g., nanopi-m6.csc)
   - Defconfig file or patches
   - Any DDR/BL31 blob specifications

2. If defconfig is a patch file:
   - Apply to rock5a-rk3588s_defconfig mentally or in temp location
   - Note the delta

3. Generate defconfig diff (artifacts/u-boot/nanopi-m6/defconfig.diff):
   - Compare rock5a-rk3588s_defconfig vs Armbian's M6 config
   - Format as unified diff or side-by-side comparison

4. Create analysis document (docs/ARMBIAN-UBOOT-ANALYSIS.md):
   ```markdown
   # Armbian NanoPi M6 U-Boot Analysis

   ## Source Location
   - Repository: [URL]
   - Defconfig: [path/to/defconfig]
   - Patches: [list any patches]

   ## Key CONFIG Differences from rock5a

   | CONFIG Option | rock5a Value | M6 Value | Impact |
   |---------------|--------------|----------|--------|
   | CONFIG_XYZ | y | n | [what it does] |

   ## DDR/BL31 Blob Requirements
   - DDR blob: [version]
   - BL31 blob: [version]
   - Special timing parameters: [if any]

   ## Recommended Changes for Plan 02-05

   ### Option A: Use Custom Defconfig
   1. Copy artifacts/u-boot/nanopi-m6/m6.defconfig
   2. Update pkg.yaml: `make m6_defconfig KCONFIG_CONFIG=...`

   ### Option B: Apply Patches
   1. Apply patches from artifacts/u-boot/nanopi-m6/patches/
   2. Use existing defconfig with patches

   ### Option C: Patch rock5a Defconfig
   1. Modify make command: `make rock5a-rk3588s_defconfig`
   2. Apply sed commands to change: [list options]

   ## Recommended Option: [A/B/C]
   Reason: [why this option is best]
   ```

DO NOT:
- Modify our pkg.yaml yet (that's Plan 02-05)
- Attempt to build Armbian
  </action>
  <verify>
```bash
# Verify analysis document exists and is substantive
test -f docs/ARMBIAN-UBOOT-ANALYSIS.md && \
  wc -l < docs/ARMBIAN-UBOOT-ANALYSIS.md | grep -qE '^[5-9][0-9]|^[1-9][0-9]{2}' && \
  echo "PASS: Analysis doc exists with 50+ lines" || echo "FAIL: Analysis doc missing or too short"

# Verify defconfig diff exists
test -f artifacts/u-boot/nanopi-m6/defconfig.diff && \
  wc -l < artifacts/u-boot/nanopi-m6/defconfig.diff | grep -qE '^[1-9]' && \
  echo "PASS: Defconfig diff exists" || echo "FAIL: Defconfig diff missing"

# Verify analysis contains recommended option
grep -q "Recommended Option" docs/ARMBIAN-UBOOT-ANALYSIS.md && \
  echo "PASS: Contains recommendation" || echo "FAIL: Missing recommendation"

# Verify analysis identifies defconfig source
grep -qE "defconfig|CONFIG_" docs/ARMBIAN-UBOOT-ANALYSIS.md && \
  echo "PASS: Contains defconfig info" || echo "FAIL: Missing defconfig info"
```
  </verify>
  <done>
Armbian NanoPi M6 U-Boot configuration fully documented with:
- Source repository and path to defconfig
- Key CONFIG differences from rock5a in table format
- DDR blob requirements (version, timing parameters)
- Clear "Recommended Option" section for Plan 02-05
  </done>
</task>

</tasks>

<verification>
- [ ] Task 1: M6 config location identified (repo + path)
- [ ] docs/ARMBIAN-UBOOT-ANALYSIS.md exists and has 50+ lines
- [ ] artifacts/u-boot/nanopi-m6/defconfig.diff exists and has content
- [ ] Analysis contains "Recommended Option" section
- [ ] Analysis identifies specific CONFIG differences in table format
- [ ] Analysis provides actionable steps for Plan 02-05
</verification>

<success_criteria>
- Armbian's NanoPi M6 U-Boot configuration extracted and documented
- Key differences from rock5a-rk3588s_defconfig identified in table format
- Clear "Recommended Option" with step-by-step instructions for Plan 02-05
</success_criteria>

<output>
After completion, create `.planning/phases/02-bootloader/02-04-SUMMARY.md`
</output>
