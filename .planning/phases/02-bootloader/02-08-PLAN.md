---
phase: 02-bootloader
plan: 08
type: execute
wave: 1
depends_on: [02-07]
files_modified:
  - docs/BOOT-TEST-CHECKLIST.md
  - docs/ARMBIAN-BOOTLOADER-EXTRACTION.md
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "Armbian's bootloader binary extracted and tested on our SD card"
    - "Root cause identified: either build process or boot media"
    - "Next action determined based on diagnostic outcome"
  artifacts:
    - path: "docs/ARMBIAN-BOOTLOADER-EXTRACTION.md"
      provides: "Procedure to extract and test Armbian's u-boot-rockchip.bin"
    - path: "docs/BOOT-TEST-CHECKLIST.md"
      provides: "Attempt #5 results with Armbian binary"
  key_links:
    - from: "Armbian SD card image"
      to: "u-boot-rockchip.bin extraction"
      via: "dd command at sector offset"
---

<objective>
Test Armbian's exact u-boot-rockchip.bin bootloader on our SD card to diagnose whether the boot failure is in our build process or the SD card boot path.

Purpose: After 4 failed boot attempts with configuration matching Armbian exactly, this diagnostic test will determine the root cause by eliminating the build process variable - using Armbian's proven-working binary.

Output: Boot test Attempt #5 results, extraction procedure documentation, and clear next step determination.
</objective>

<execution_context>
@/Users/johnsonhuynh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johnsonhuynh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-bootloader/02-07-SUMMARY.md
@docs/BOOT-TEST-CHECKLIST.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract bootloader from Armbian SD card image</name>
  <files>docs/ARMBIAN-BOOTLOADER-EXTRACTION.md</files>
  <action>
    Create procedure document for extracting Armbian's bootloader:

    1. Identify the working Armbian SD card image location:
       - User has a working Armbian SD card from Phase 1 hardware verification
       - Armbian images store bootloader at specific sector offsets

    2. Document bootloader location in Rockchip images:
       - RK3588/RK3588S bootloader starts at sector 64 (32KB offset)
       - Total bootloader size is approximately 8-10MB
       - Contains: idbloader.img (TPL+SPL), u-boot.itb (U-Boot + DTB)

    3. Create extraction commands:
       ```bash
       # Option A: Extract from Armbian SD card device directly
       # WARNING: Ensure correct device - check with diskutil list
       sudo dd if=/dev/diskN of=armbian-bootloader.bin bs=512 skip=64 count=20480

       # Option B: Extract from Armbian .img file
       dd if=Armbian_xxx_nanopi-m6.img of=armbian-bootloader.bin bs=512 skip=64 count=20480
       ```

    4. Verify extraction:
       - File size should be ~10MB (20480 * 512 bytes)
       - First bytes should contain idbloader signature

    5. Document flash procedure:
       ```bash
       # Flash ONLY bootloader to target SD card (preserves partitions)
       sudo dd if=armbian-bootloader.bin of=/dev/diskN bs=512 seek=64
       ```

    Include warnings about device identification to prevent data loss.
    Reference existing MASKROM-RECOVERY.md for context.
  </action>
  <verify>ls -la docs/ARMBIAN-BOOTLOADER-EXTRACTION.md && wc -l docs/ARMBIAN-BOOTLOADER-EXTRACTION.md</verify>
  <done>Extraction procedure document exists with complete commands for both device and image file sources</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: User extracts and flashes Armbian bootloader</name>
  <action>
    User must perform physical hardware operations:

    **Step 1: Identify Armbian source**
    - If Armbian SD card available: Use device directly
    - If Armbian .img file available: Use image file

    **Step 2: Extract bootloader**
    Follow docs/ARMBIAN-BOOTLOADER-EXTRACTION.md to extract ~10MB bootloader binary.

    **Step 3: Flash to test SD card**
    Flash the extracted bootloader to the SD card currently used for testing.
    This preserves existing partitions - only replaces bootloader sectors.

    **Step 4: Boot test**
    Insert SD card into NanoPi M6 and power on.
    Observe for 2 minutes following standard boot test protocol.
  </action>
  <how-to-verify>
    1. Bootloader extracted (file exists, ~10MB size)
    2. Bootloader flashed to SD card (dd command completed)
    3. Boot test performed (2-minute observation)
  </how-to-verify>
  <resume-signal>Report boot test result: "Armbian binary BOOTS" or "Armbian binary FAILS"</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Document boot test Attempt #5 and determine next action</name>
  <files>docs/BOOT-TEST-CHECKLIST.md</files>
  <action>
    Based on user's reported boot test result, update BOOT-TEST-CHECKLIST.md with Attempt #5:

    **If user reports "Armbian binary BOOTS":**
    - Record success indicators (LED activity, HDMI output if any, network)
    - Conclusion: Issue is in our BUILD PROCESS, not hardware/SD card
    - Next action: Compare our binary vs Armbian's binary to identify build difference
    - May need to match Armbian's exact toolchain or build flags

    **If user reports "Armbian binary FAILS":**
    - Record same failure symptoms as Attempts #1-4
    - Conclusion: Issue is in SD CARD BOOT PATH, not our build
    - Next action: Test eMMC boot path via MaskROM mode
    - SD card boot may not be supported or requires specific configuration
    - Update VERIFICATION.md recommendation accordingly

    **Configuration for Attempt #5:**
    - Defconfig: N/A (pre-built binary)
    - DDR blob: Armbian's embedded version
    - BL31 blob: Armbian's embedded version
    - U-Boot source: Armbian's pre-built binary
    - SD card: Same 32GB card with our partitions

    Fill in observation timeline, result, and next steps based on user input.
  </action>
  <verify>grep -c "Attempt #5" docs/BOOT-TEST-CHECKLIST.md</verify>
  <done>Attempt #5 documented with conclusion and clear next action identified</done>
</task>

</tasks>

<verification>
Plan success requires:
1. Extraction procedure documented (Task 1)
2. User completes hardware test (Task 2)
3. Results documented with diagnosis (Task 3)
4. Clear path forward identified based on test outcome
</verification>

<success_criteria>
- ARMBIAN-BOOTLOADER-EXTRACTION.md exists with complete extraction procedure
- BOOT-TEST-CHECKLIST.md updated with Attempt #5 results
- Root cause narrowed to either: build process OR SD card boot path
- Next gap closure plan direction determined
</success_criteria>

<output>
After completion, create `.planning/phases/02-bootloader/02-08-SUMMARY.md`
</output>
