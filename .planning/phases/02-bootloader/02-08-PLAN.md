---
phase: 02-bootloader
plan: 08
type: execute
wave: 2
depends_on: ["07"]
files_modified:
  - docs/BOOT-TEST-CHECKLIST.md
  - docs/FRIENDLYELEC-BOOTLOADER-EXTRACTION.md
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "FriendlyElec's bootloader binary extracted and tested on our SD card"
    - "Root cause identified: mainline U-Boot vs vendor U-Boot (v2017.09)"
    - "Next action determined based on diagnostic outcome"
  artifacts:
    - path: "docs/FRIENDLYELEC-BOOTLOADER-EXTRACTION.md"
      provides: "Procedure to extract FriendlyElec's bootloader from working Ubuntu SD card"
    - path: "docs/BOOT-TEST-CHECKLIST.md"
      provides: "Attempt #5 results with FriendlyElec vendor bootloader"
  key_links:
    - from: "FriendlyElec Ubuntu SD card"
      to: "bootloader binary extraction"
      via: "dd command at sector 64 offset"
---

<objective>
Test FriendlyElec's vendor bootloader (U-Boot v2017.09 + MiniLoaderAll) on our SD card to diagnose if NanoPi M6 requires vendor U-Boot instead of mainline.

Purpose: After 4 failed boot attempts with mainline U-Boot (even matching Armbian's exact configuration), test the PROVEN-WORKING FriendlyElec bootloader from the user's Ubuntu SD card. FriendlyElec uses vendor U-Boot v2017.09 with MiniLoaderAll.bin format - fundamentally different from our mainline approach.

Output: Boot test Attempt #5 results, extraction procedure documentation, and clear determination of whether vendor U-Boot is required.
</objective>

<execution_context>
@/Users/johnsonhuynh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johnsonhuynh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-bootloader/02-07-SUMMARY.md
@docs/BOOT-TEST-CHECKLIST.md
</context>

<gap_context>
## New Discovery

FriendlyElec official images use a DIFFERENT bootloader approach:

| Component | Our Build (Mainline) | FriendlyElec (Vendor) |
|-----------|---------------------|----------------------|
| U-Boot version | v2025.10 (mainline) | v2017.09 (vendor fork) |
| Defconfig | nanopi-m6-rk3588s | nanopi6_defconfig |
| Loader format | u-boot-rockchip.bin (combined) | MiniLoaderAll.bin + uboot.img (separate) |
| Boot chain | TPL+SPL+U-Boot (combined) | idbloader + uboot.img (Rockchip format) |

User has confirmed FriendlyElec Ubuntu boots successfully on their NanoPi M6, proving:
1. Hardware is functional
2. SD card boot works
3. Their SD card works

This eliminates SD card boot path as a suspect. The issue is likely the mainline U-Boot approach itself.
</gap_context>

<tasks>

<task type="auto">
  <name>Task 1: Document FriendlyElec bootloader extraction procedure</name>
  <files>docs/FRIENDLYELEC-BOOTLOADER-EXTRACTION.md</files>
  <action>
Create procedure document for extracting FriendlyElec's bootloader:

1. **Bootloader location in Rockchip images:**
   - RK3588/RK3588S bootloader starts at sector 64 (32KB offset)
   - Total bootloader region is approximately 8-10MB (up to sector 20544)
   - Contains: idbloader.img (DDR+SPL) + uboot.img (U-Boot proper)

2. **Extraction from working FriendlyElec SD card:**
   ```bash
   # On macOS - first identify the SD card device
   diskutil list

   # Extract bootloader region (sectors 64 to ~20544)
   # WARNING: Use rdiskN for better performance
   sudo dd if=/dev/rdiskN of=friendlyelec-bootloader.bin bs=512 skip=64 count=20480 status=progress
   ```

3. **Verify extraction:**
   - File size should be ~10MB (20480 * 512 = 10,485,760 bytes)
   - Hexdump first bytes to verify valid idbloader signature

4. **Flash to test SD card:**
   ```bash
   # Flash ONLY bootloader to target SD card (preserves partitions)
   # This replaces our mainline U-Boot with FriendlyElec's vendor U-Boot
   sudo dd if=friendlyelec-bootloader.bin of=/dev/rdiskN bs=512 seek=64 status=progress
   sync
   ```

5. **Include safety warnings:**
   - Triple-check device identification before dd commands
   - Reference MASKROM-RECOVERY.md for recovery if needed
   - Note this is diagnostic only - will need to rebuild for Talos

Document the key difference: FriendlyElec uses MiniLoaderAll format (Rockchip proprietary) vs our u-boot-rockchip.bin (mainline open source).
  </action>
  <verify>ls -la docs/FRIENDLYELEC-BOOTLOADER-EXTRACTION.md && wc -l docs/FRIENDLYELEC-BOOTLOADER-EXTRACTION.md</verify>
  <done>Extraction procedure document exists with complete commands for FriendlyElec SD card source</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: User extracts and tests FriendlyElec bootloader</name>
  <action>
User performs hardware operations:

**Step 1: Identify devices**
```bash
diskutil list
```
- Note device for FriendlyElec Ubuntu SD card (source)
- Note device for test SD card (destination)

**Step 2: Extract FriendlyElec bootloader**
Insert the FriendlyElec Ubuntu SD card and extract:
```bash
sudo dd if=/dev/rdiskN of=friendlyelec-bootloader.bin bs=512 skip=64 count=20480 status=progress
```

Verify: `ls -la friendlyelec-bootloader.bin` should show ~10MB file

**Step 3: Flash to test SD card**
Insert the test SD card (the one we've been using for boot tests):
```bash
sudo dd if=friendlyelec-bootloader.bin of=/dev/rdiskN bs=512 seek=64 status=progress
sync
```

**Step 4: Boot test**
- Insert test SD card into NanoPi M6
- Power on
- Observe for 2 minutes (standard boot test protocol)

**What to observe:**
- LEDs: Any blinking within 0-10 seconds?
- HDMI: Any output? (FriendlyElec U-Boot may have video driver)
- Network: DHCP lease acquired?
  </action>
  <how-to-verify>
1. Bootloader extracted (file exists, ~10MB size)
2. Bootloader flashed to test SD card
3. Boot test performed (2-minute observation)
  </how-to-verify>
  <resume-signal>
Report boot test result:
- "FriendlyElec BOOTS" - LEDs blinked, boot activity observed
- "FriendlyElec FAILS" - Same failure as before, no LED activity
  </resume-signal>
</task>

<task type="auto">
  <name>Task 3: Document Attempt #5 and determine path forward</name>
  <files>docs/BOOT-TEST-CHECKLIST.md</files>
  <action>
Based on user's reported boot test result, update BOOT-TEST-CHECKLIST.md with Attempt #5:

**If user reports "FriendlyElec BOOTS":**
- Record success indicators (LED activity, HDMI output, network)
- **CONCLUSION: NanoPi M6 REQUIRES vendor U-Boot (v2017.09), NOT mainline**
- Root cause: Mainline U-Boot boot chain differs from Rockchip's expected format
- Next action: Investigate using FriendlyElec's U-Boot source or vendor-style build
- Document this as a CRITICAL FINDING for the project
- Update STATE.md with this architectural decision

**If user reports "FriendlyElec FAILS":**
- This would be unexpected since FriendlyElec Ubuntu boots
- Check if correct SD card was used
- Check if extraction was complete
- May indicate SD card hardware issue or user error
- Next action: Re-verify extraction and try again

**Configuration for Attempt #5:**
- Defconfig: FriendlyElec nanopi6_defconfig (pre-built)
- U-Boot version: v2017.09 (vendor fork)
- Loader format: MiniLoaderAll.bin + uboot.img
- DDR blob: FriendlyElec's embedded version
- BL31 blob: FriendlyElec's embedded version
- SD card: Same 32GB card, FriendlyElec bootloader

Add detailed observation timeline, result, and next steps.
  </action>
  <verify>grep -c "Attempt #5" docs/BOOT-TEST-CHECKLIST.md</verify>
  <done>Attempt #5 documented with conclusion and architectural decision recorded</done>
</task>

</tasks>

<verification>
Plan success requires:
1. Extraction procedure documented (Task 1)
2. User completes hardware test with FriendlyElec bootloader (Task 2)
3. Results documented with diagnosis (Task 3)
4. Clear architectural decision: vendor U-Boot required or not
</verification>

<success_criteria>
- FRIENDLYELEC-BOOTLOADER-EXTRACTION.md exists with complete extraction procedure
- BOOT-TEST-CHECKLIST.md updated with Attempt #5 results
- Root cause determined: mainline U-Boot incompatible vs other issue
- If FriendlyElec boots: Document requirement for vendor U-Boot approach
- Path forward for Phase 2 completion identified
</success_criteria>

<output>
After completion, create `.planning/phases/02-bootloader/02-08-SUMMARY.md`

If FriendlyElec bootloader works, update:
- STATE.md with architectural decision (vendor U-Boot required)
- VERIFICATION.md gaps with resolution path
- Consider Phase 2 strategy pivot to vendor U-Boot integration
</output>
