---
phase: 02-bootloader
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - Pkgfile
  - artifacts/u-boot/prepare/pkg.yaml
  - artifacts/u-boot/nanopi-m6/pkg.yaml
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "U-Boot binary compiles with actual nanopi-m6-rk3588s_defconfig"
    - "DDR memory initializes on NanoPi M6 hardware (LED activity observed)"
    - "Boot activity observable (LED blink or HDMI output)"
  artifacts:
    - path: "Pkgfile"
      provides: "Mainline U-Boot v2025.10 source reference"
      contains: "v2025.10"
    - path: "artifacts/u-boot/prepare/pkg.yaml"
      provides: "Mainline U-Boot source URL (github.com/u-boot/u-boot)"
      contains: "github.com/u-boot/u-boot"
    - path: "artifacts/u-boot/nanopi-m6/pkg.yaml"
      provides: "NanoPi M6 defconfig from Armbian"
      contains: "nanopi-m6-rk3588s_defconfig"
    - path: "_out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin"
      provides: "Compiled U-Boot binary"
  key_links:
    - from: "Pkgfile"
      to: "artifacts/u-boot/prepare/pkg.yaml"
      via: "uboot_version variable"
      pattern: "uboot_version"
    - from: "artifacts/u-boot/prepare/pkg.yaml"
      to: "github.com/u-boot/u-boot"
      via: "source download URL"
      pattern: "github.com/u-boot/u-boot"
    - from: "artifacts/u-boot/nanopi-m6/pkg.yaml"
      to: "Armbian defconfig"
      via: "curl download during prepare"
      pattern: "nanopi-m6-rk3588s_defconfig"
---

<objective>
Switch U-Boot source from Collabora fork (v2023.07) to mainline U-Boot v2025.10 and use Armbian's proven NanoPi M6 configuration.

Purpose: The Collabora U-Boot fork lacks NanoPi M6 support. Boot tests (Attempts #1 and #2) failed at DDR/SPL stage - before device tree parsing. Armbian successfully boots M6 using mainline U-Boot v2025.10 with nanopi-m6-rk3588s_defconfig. This plan switches to the proven working configuration.

Output:
- Updated Pkgfile with mainline U-Boot v2025.10 reference
- Updated prepare/pkg.yaml to fetch from GitHub instead of Collabora GitLab
- Updated nanopi-m6/pkg.yaml to use Armbian's defconfig and DTS
- Working U-Boot binary tested on hardware
</objective>

<execution_context>
@/Users/johnsonhuynh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johnsonhuynh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@docs/ARMBIAN-UBOOT-ANALYSIS.md
@.planning/phases/02-bootloader/02-05-SUMMARY.md

# Key files to modify
@Pkgfile
@artifacts/u-boot/prepare/pkg.yaml
@artifacts/u-boot/nanopi-m6/pkg.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Switch U-Boot source to mainline v2025.10</name>
  <files>
    - Pkgfile
    - artifacts/u-boot/prepare/pkg.yaml
  </files>
  <action>
Update Pkgfile to reference mainline U-Boot v2025.10:

1. Update uboot_version to tag v2025.10:
   - Old: ef0ae64c1505e063f1952a1d69c7f97e904848c5 (Collabora 2023.07-rc4)
   - New: v2025.10

2. Compute new checksums by downloading the tarball:
   ```bash
   curl -sL "https://github.com/u-boot/u-boot/archive/refs/tags/v2025.10.tar.gz" | sha256sum
   curl -sL "https://github.com/u-boot/u-boot/archive/refs/tags/v2025.10.tar.gz" | sha512sum
   ```
   Update uboot_sha256 and uboot_sha512 with computed values.

3. Update renovate comment to reflect new source:
   ```yaml
   # renovate: datasource=github-releases depName=u-boot/u-boot
   uboot_version: v2025.10
   ```

4. Update artifacts/u-boot/prepare/pkg.yaml:
   - Change URL from Collabora GitLab to GitHub releases:
   - Old: https://gitlab.collabora.com/hardware-enablement/rockchip-3588/u-boot/-/archive/{{ .uboot_version }}/u-boot-{{ .uboot_version }}.tar.bz2
   - New: https://github.com/u-boot/u-boot/archive/refs/tags/{{ .uboot_version }}.tar.gz
   - Change destination from u-boot.tar.bz2 to u-boot.tar.gz
   - Update tar extraction to handle .tar.gz format

IMPORTANT: Mainline U-Boot v2025.10 already contains nanopi-m6-rk3588s_defconfig and rk3588s-nanopi-m6.dts - no need to download from Armbian if they're in mainline.
  </action>
  <verify>
    - `grep "v2025.10" Pkgfile` returns the version line
    - `grep "github.com/u-boot/u-boot" artifacts/u-boot/prepare/pkg.yaml` returns URL
    - Checksums in Pkgfile are valid (64 hex chars for sha256, 128 for sha512)
  </verify>
  <done>
    - Pkgfile references mainline U-Boot v2025.10 with valid checksums
    - prepare/pkg.yaml fetches from GitHub instead of Collabora GitLab
  </done>
</task>

<task type="auto">
  <name>Task 2: Update NanoPi M6 build configuration</name>
  <files>
    - artifacts/u-boot/nanopi-m6/pkg.yaml
  </files>
  <action>
Simplify artifacts/u-boot/nanopi-m6/pkg.yaml to use mainline defconfig directly:

1. Since mainline U-Boot v2025.10 includes nanopi-m6-rk3588s_defconfig, simplify prepare section:
   ```yaml
   prepare:
     - |
       cd /src
       # Use mainline defconfig directly (v2025.10 has native M6 support)
       make nanopi-m6-rk3588s_defconfig
   ```

2. Remove all the old patching logic:
   - Remove custom DTS copying (no longer needed)
   - Remove Makefile patching (no longer needed)
   - Remove rock5a defconfig with sed patches (no longer needed)
   - Remove OF_LIST, DEFAULT_DEVICE_TREE sed commands (no longer needed)

3. If mainline lacks the defconfig (unlikely but possible), fall back to Armbian download:
   ```yaml
   prepare:
     - |
       cd /src
       # Check if mainline has M6 defconfig
       if [ -f configs/nanopi-m6-rk3588s_defconfig ]; then
         make nanopi-m6-rk3588s_defconfig
       else
         # Fall back to Armbian's tested config
         curl -fsSL -o configs/nanopi-m6-rk3588s_defconfig \
           "https://raw.githubusercontent.com/armbian/build/main/patch/u-boot/v2025.10/defconfig/nanopi-m6-rk3588s_defconfig"
         make nanopi-m6-rk3588s_defconfig
       fi
   ```

4. Consider updating DDR/BL31 blob versions to match Armbian (optional but recommended):
   - Current: DDR v1.16, BL31 v1.45
   - Armbian: DDR v1.18, BL31 v1.48
   - If updating, also update the rkbin reference in Pkgfile

5. Remove or update the CFLAGS with debug logging (keep for now to aid debugging).

6. Remove the local rk3588s-nanopi-m6.dts file after confirming mainline has it:
   ```bash
   rm artifacts/u-boot/nanopi-m6/rk3588s-nanopi-m6.dts
   ```
   (Or keep as backup - executor's discretion)
  </action>
  <verify>
    - `grep "nanopi-m6-rk3588s_defconfig" artifacts/u-boot/nanopi-m6/pkg.yaml` returns make command
    - `grep -v "rock5a" artifacts/u-boot/nanopi-m6/pkg.yaml` shows no rock5a references (except comments)
    - No sed patching commands remain in prepare section
  </verify>
  <done>
    - pkg.yaml uses mainline nanopi-m6-rk3588s_defconfig directly
    - No device tree patching or defconfig transformations
    - Clean, simple build configuration
  </done>
</task>

<task type="auto">
  <name>Task 3: Build U-Boot and flash to SD card</name>
  <files>
    - _out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin
  </files>
  <action>
Build and flash the new U-Boot:

1. Clean previous build artifacts:
   ```bash
   rm -rf _out/artifacts/arm64/u-boot/nanopi-m6/
   ```

2. Run the build:
   ```bash
   make local-talos-sbc-rk3588-mainline DEST=_out
   ```

   If build fails due to missing dependencies or config issues, troubleshoot:
   - Check if nanopi-m6-rk3588s_defconfig exists in the downloaded source
   - Check if DTS file exists at arch/arm/dts/rk3588s-nanopi-m6.dts
   - If missing, download from Armbian as fallback

3. Verify build output:
   ```bash
   ls -la _out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin
   ```
   Expected: Binary file 8-10MB in size

4. Flash to SD card:
   ```bash
   ./hack/flash.sh --bootloader _out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin
   ```

5. Document any build errors or warnings for the summary.
  </action>
  <verify>
    - `ls _out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin` exists
    - Binary size is 8-10MB (indicates complete build with DDR/BL31)
    - Flash completes without errors
  </verify>
  <done>
    - U-Boot binary built successfully with mainline source and M6 defconfig
    - Binary flashed to SD card ready for testing
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Hardware boot verification</name>
  <what-built>
    U-Boot built from mainline v2025.10 with native nanopi-m6-rk3588s_defconfig. This is the same configuration that Armbian uses to successfully boot the NanoPi M6.
  </what-built>
  <how-to-verify>
    **Boot Test Procedure:**

    1. Insert flashed SD card into NanoPi M6
    2. Connect HDMI cable to monitor
    3. Connect Ethernet cable (for DHCP observation)
    4. Power on the device

    **Observe these indicators in order:**

    | Time Window | Indicator | Expected (SUCCESS) | Previous (FAILED) |
    |-------------|-----------|-------------------|-------------------|
    | 0-5s | Power LED | Solid ON | Solid ON |
    | 0-10s | SYS LED | Blink pattern | No activity |
    | 10-30s | HDMI | U-Boot logo/splash | No signal |
    | 30-120s | HDMI | Boot messages or kernel | No signal |
    | 30-120s | Network | DHCP lease | No lease |

    **Success criteria (ANY of these = SUCCESS):**
    - SYS LED shows activity (any blink pattern)
    - HDMI shows any output (logo, text, splash)
    - Router shows DHCP lease from device

    **Document in BOOT-TEST-CHECKLIST.md:**
    - Attempt #3 with mainline U-Boot v2025.10
    - All observations at each time window
    - Final verdict: SUCCESS or FAILED

    **Recovery if needed:**
    - See docs/MASKROM-RECOVERY.md for re-flash procedure
  </how-to-verify>
  <resume-signal>
    Type "boot-success" if LED/HDMI/network activity observed.
    Type "boot-failed" with observations if no activity.
  </resume-signal>
</task>

</tasks>

<verification>
Phase 2 success criteria after this plan:

1. U-Boot binary compiles with NanoPi M6-specific defconfig
   - Verify: `grep "nanopi-m6-rk3588s_defconfig" artifacts/u-boot/nanopi-m6/pkg.yaml`

2. DDR memory initializes (LPDDR5 blob loads correctly)
   - Verify: LED activity in 0-10s window during boot test

3. Boot activity observable (LED blink or eventual kernel HDMI output)
   - Verify: Any of: LED blink, HDMI output, DHCP lease

4. Recovery procedure documented and tested (MaskROM mode)
   - Already complete from 02-02

Overall phase verification command:
```bash
# Check build config
grep -E "v2025.10|nanopi-m6-rk3588s_defconfig" Pkgfile artifacts/u-boot/nanopi-m6/pkg.yaml

# Check binary exists
ls -la _out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin
```
</verification>

<success_criteria>
Plan 02-06 is complete when:
- [ ] Pkgfile references mainline U-Boot v2025.10 (not Collabora fork)
- [ ] prepare/pkg.yaml fetches from github.com/u-boot/u-boot
- [ ] nanopi-m6/pkg.yaml uses nanopi-m6-rk3588s_defconfig directly
- [ ] U-Boot binary builds successfully (8-10MB)
- [ ] Hardware boot test shows activity (LED, HDMI, or network)
- [ ] BOOT-TEST-CHECKLIST.md updated with Attempt #3 results
</success_criteria>

<output>
After completion, create `.planning/phases/02-bootloader/02-06-SUMMARY.md` using the summary template.

Update STATE.md with:
- Decision: Switched to mainline U-Boot v2025.10
- Boot test result (success or failure)
- Next steps based on outcome
</output>
