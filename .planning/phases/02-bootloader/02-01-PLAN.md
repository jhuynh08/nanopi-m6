---
phase: 02-bootloader
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - artifacts/u-boot/nanopi-m6/pkg.yaml
  - artifacts/u-boot/pkg.yaml
autonomous: true

must_haves:
  truths:
    - "U-Boot build system recognizes nanopi-m6 as a valid target"
    - "Build configuration uses correct DDR blob for LPDDR5"
    - "Build configuration uses correct BL31 blob"
  artifacts:
    - path: "artifacts/u-boot/nanopi-m6/pkg.yaml"
      provides: "NanoPi M6 U-Boot build configuration"
      contains: "nanopi-r6c-rk3588s_defconfig"
    - path: "artifacts/u-boot/pkg.yaml"
      provides: "Aggregated U-Boot builds"
      contains: "u-boot-nanopi-m6"
  key_links:
    - from: "artifacts/u-boot/pkg.yaml"
      to: "artifacts/u-boot/nanopi-m6/pkg.yaml"
      via: "dependency declaration"
      pattern: "stage: u-boot-nanopi-m6"
---

<objective>
Create U-Boot build configuration for NanoPi M6

Purpose: Enable the bldr/kres build system to compile U-Boot for NanoPi M6 using the nanopi-r6c-rk3588s_defconfig as a base (same RK3588S SoC). This is the first step in bootloader bring-up.

Output:
- `artifacts/u-boot/nanopi-m6/pkg.yaml` - Build configuration for NanoPi M6
- Updated `artifacts/u-boot/pkg.yaml` - Aggregator including nanopi-m6
</objective>

<execution_context>
@/Users/johnsonhuynh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johnsonhuynh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-bootloader/02-RESEARCH.md

# Reference existing U-Boot configurations
@artifacts/u-boot/rock5a/pkg.yaml
@artifacts/u-boot/rock5b/pkg.yaml
@artifacts/u-boot/pkg.yaml
@artifacts/u-boot/prepare/pkg.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NanoPi M6 U-Boot pkg.yaml</name>
  <files>artifacts/u-boot/nanopi-m6/pkg.yaml</files>
  <action>
Create directory `artifacts/u-boot/nanopi-m6/` and create `pkg.yaml` following the rock5a pattern:

```yaml
name: u-boot-nanopi-m6
variant: scratch
shell: /toolchain/bin/bash
dependencies:
  - stage: rkbin
  - stage: u-boot-prepare
steps:
  - env:
      SOURCE_DATE_EPOCH: {{ .BUILD_ARG_SOURCE_DATE_EPOCH }}
      ROCKCHIP_TPL: /libs/rkbin/bin/rk35/rk3588_ddr_lp4_2112MHz_lp5_2400MHz_v1.16.bin
      BL31: /libs/rkbin/bin/rk35/rk3588_bl31_v1.45.elf
    prepare:
      - |
        cd /src
        make nanopi-r6c-rk3588s_defconfig
    build:
      - |
        cd /src
        make -j $(nproc) HOSTLDLIBS_mkimage="-lssl -lcrypto"
    install:
      - |
        mkdir -p /rootfs/artifacts/arm64/u-boot/nanopi-m6
        cp -v /src/u-boot-rockchip.bin /rootfs/artifacts/arm64/u-boot/nanopi-m6
finalize:
  - from: /rootfs
    to: /rootfs
```

Key decisions:
- Use `nanopi-r6c-rk3588s_defconfig` as base (same RK3588S SoC, per research recommendation)
- Use DDR blob v1.16 which supports LPDDR5 (NanoPi M6 uses LPDDR5)
- Use BL31 v1.45 (compatible with DDR v1.16)
- Output to `nanopi-m6/` directory to match naming convention
  </action>
  <verify>File exists at `artifacts/u-boot/nanopi-m6/pkg.yaml` with correct content</verify>
  <done>pkg.yaml created with nanopi-r6c-rk3588s_defconfig and correct blob paths</done>
</task>

<task type="auto">
  <name>Task 2: Update U-Boot aggregator pkg.yaml</name>
  <files>artifacts/u-boot/pkg.yaml</files>
  <action>
Update `artifacts/u-boot/pkg.yaml` to include nanopi-m6 in the dependencies list.

Current content:
```yaml
name: u-boot
variant: scratch
dependencies:
  - stage: u-boot-rock-5a
  - stage: u-boot-rock-5b
finalize:
  - from: /rootfs
    to: /rootfs
```

Update to:
```yaml
name: u-boot
variant: scratch
dependencies:
  - stage: u-boot-rock-5a
  - stage: u-boot-rock-5b
  - stage: u-boot-nanopi-m6
finalize:
  - from: /rootfs
    to: /rootfs
```

This registers nanopi-m6 as a build target in the U-Boot aggregator.
  </action>
  <verify>Run `grep "u-boot-nanopi-m6" artifacts/u-boot/pkg.yaml` returns match</verify>
  <done>U-Boot aggregator includes u-boot-nanopi-m6 dependency</done>
</task>

</tasks>

<verification>
1. Directory structure exists: `ls artifacts/u-boot/nanopi-m6/`
2. pkg.yaml syntax valid: Check YAML structure
3. Aggregator updated: `grep "nanopi-m6" artifacts/u-boot/pkg.yaml`
4. Blob paths match rkbin: Verify paths reference correct LPDDR5-supporting DDR blob
</verification>

<success_criteria>
- [ ] `artifacts/u-boot/nanopi-m6/pkg.yaml` exists with valid YAML
- [ ] Uses `nanopi-r6c-rk3588s_defconfig` (R6C has same RK3588S SoC)
- [ ] DDR blob path includes `lp5` (LPDDR5 support required for NanoPi M6)
- [ ] `artifacts/u-boot/pkg.yaml` lists `u-boot-nanopi-m6` in dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/02-bootloader/02-01-SUMMARY.md`
</output>
