---
phase: 02-bootloader
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/MASKROM-RECOVERY.md
  - docs/BOOT-TEST-CHECKLIST.md
autonomous: true

must_haves:
  truths:
    - "User can recover from a bricked SD card boot using MaskROM mode"
    - "User can systematically track boot attempts and observations"
    - "Recovery procedure does not require UART"
  artifacts:
    - path: "docs/MASKROM-RECOVERY.md"
      provides: "Step-by-step MaskROM recovery procedure"
      contains: "rkdeveloptool"
    - path: "docs/BOOT-TEST-CHECKLIST.md"
      provides: "Structured boot attempt tracking template"
      contains: "LED activity"
  key_links:
    - from: "docs/BOOT-TEST-CHECKLIST.md"
      to: "docs/MASKROM-RECOVERY.md"
      via: "cross-reference for failure recovery"
      pattern: "MASKROM-RECOVERY"
---

<objective>
Create recovery and iteration documentation for bootloader bring-up

Purpose: Without UART, debugging boot failures requires systematic iteration and documented recovery procedures. MaskROM mode is the last-resort recovery when SD card boot fails. The boot test checklist enables tracking observations across multiple configuration attempts.

Output:
- `docs/MASKROM-RECOVERY.md` - Complete MaskROM recovery procedure for NanoPi M6
- `docs/BOOT-TEST-CHECKLIST.md` - Template for tracking boot attempts
</objective>

<execution_context>
@/Users/johnsonhuynh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johnsonhuynh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-bootloader/02-CONTEXT.md
@.planning/phases/02-bootloader/02-RESEARCH.md

# Reference existing flash workflow
@docs/FLASH-WORKFLOW.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MaskROM Recovery Documentation</name>
  <files>docs/MASKROM-RECOVERY.md</files>
  <action>
Create comprehensive MaskROM recovery documentation at `docs/MASKROM-RECOVERY.md`:

```markdown
# MaskROM Recovery Procedure for NanoPi M6

## Overview

MaskROM mode is a last-resort recovery mechanism built into the RK3588S SoC. When the boot ROM cannot find a valid bootloader, or when manually triggered, the device enters MaskROM mode and waits for commands via USB.

**When to use MaskROM:**
- SD card boot fails completely (no LED activity after power-on)
- Need to erase eMMC boot sectors to force SD card boot priority
- Debugging boot chain issues

**Important:** This guide assumes SD card-only boot. We do NOT flash eMMC during Phase 2.

## Prerequisites

### Install rkdeveloptool (macOS)

```bash
# Install via Homebrew
brew install rkdeveloptool

# Verify installation
rkdeveloptool --version
```

### Download Required Files

Download the SPL loader from rkbin repository:

```bash
# From project root
curl -L -o rk3588_spl_loader.bin \
  "https://github.com/rockchip-linux/rkbin/raw/master/bin/rk35/rk3588_spl_loader_v1.16.112.bin"
```

## Entering MaskROM Mode

### Method 1: Mask Button (Preferred)

1. **Power off** the NanoPi M6 completely (remove power cable)
2. **Locate the Mask button** - small button near the eMMC socket
3. **Press and hold** the Mask button
4. **Connect USB-C** cable to your computer (use the USB-C port marked "USB3.0/OTG")
5. **Connect power** while still holding Mask button
6. **Wait 3 seconds** then release the Mask button
7. The power LED should light up

### Method 2: No Bootloader Present

If eMMC and SD card have no valid bootloader, the device automatically enters MaskROM mode when powered on via USB-C.

## Verify MaskROM Connection

```bash
# List connected Rockchip devices
rkdeveloptool list

# Expected output:
# DevNo=1 Vid=0x2207,Pid=0x350b,LocationID=xxx Maskrom
```

**Troubleshooting if device not detected:**
- Try a different USB-C cable (data cable, not charge-only)
- Try a different USB port
- On macOS, check System Information > USB for "Rockchip" device
- Ensure you released the Mask button after 3 seconds

## Recovery Operations

### Operation 1: Erase eMMC Boot Sectors

Use this to force SD card boot priority by removing eMMC bootloader:

```bash
# Download loader first (required for any operation)
rkdeveloptool db rk3588_spl_loader.bin

# Erase first 32MB of eMMC (clears bootloader area)
rkdeveloptool ef

# Reset device
rkdeveloptool rd
```

After this, the device will boot from SD card (since eMMC has no bootloader).

### Operation 2: Flash Bootloader to SD Card

**Note:** For SD card, use `dd` instead of rkdeveloptool. This operation is for reference only.

```bash
# On macOS - see docs/FLASH-WORKFLOW.md for full procedure
diskutil unmountDisk /dev/diskN
sudo dd if=u-boot-rockchip.bin of=/dev/rdiskN seek=64 bs=512 status=progress
sync
diskutil eject /dev/diskN
```

### Operation 3: Read eMMC to Verify State

```bash
# Download loader
rkdeveloptool db rk3588_spl_loader.bin

# Read first 64 sectors from eMMC to file
rkdeveloptool rl 0x0 0x40 emmc_header.bin

# Check if bootloader signature present
hexdump -C emmc_header.bin | head -20
# If you see "3b 8c dc fc" at offset 0 - bootloader present
# If all zeros or random data - no bootloader
```

## Recovery Scenarios

### Scenario: SD Card Boot Fails, No Activity

1. Enter MaskROM mode (Method 1)
2. Verify connection: `rkdeveloptool list`
3. Erase eMMC boot sectors: `rkdeveloptool db rk3588_spl_loader.bin && rkdeveloptool ef`
4. Reset: `rkdeveloptool rd`
5. Power off, remove USB
6. Insert new SD card image, power on normally

### Scenario: Device Seems Bricked

1. Remove all storage (SD card, disconnect eMMC if possible)
2. Enter MaskROM mode - device should enter automatically when no storage has bootloader
3. If MaskROM detected, device is NOT bricked - just missing bootloader
4. Flash SD card with known-good Armbian image
5. Insert SD card, power on

### Scenario: Need to Start Fresh

1. Enter MaskROM mode
2. Erase eMMC: `rkdeveloptool db rk3588_spl_loader.bin && rkdeveloptool ef && rkdeveloptool rd`
3. Power off
4. Flash fresh Armbian image to SD card (known working baseline from Phase 1)
5. Verify Armbian boots - confirms hardware is OK
6. Re-flash with U-Boot test image

## Troubleshooting

| Symptom | Likely Cause | Solution |
|---------|--------------|----------|
| `rkdeveloptool list` shows nothing | Wrong USB port or cable | Try USB-C OTG port, use data cable |
| "Creating Comm Object failed" | Permission issue | Run with sudo or add udev rule |
| Device shows "Loader" not "Maskrom" | Partial boot, not MaskROM | Power cycle, hold Mask button longer |
| "The device does not support..." | Wrong loader file | Download correct rk3588_spl_loader |

## Safety Notes

- **Never flash eMMC during Phase 2** - SD card only
- **Keep Armbian SD card** as recovery backup
- **Document every boot attempt** in BOOT-TEST-CHECKLIST.md
- **Wait full 2 minutes** before declaring boot failure

---

*Part of Phase 2: Bootloader Bring-Up*
*See also: [Flash Workflow](FLASH-WORKFLOW.md), [Boot Test Checklist](BOOT-TEST-CHECKLIST.md)*
```
  </action>
  <verify>File exists and contains rkdeveloptool commands</verify>
  <done>MaskROM recovery documentation created with macOS-specific instructions</done>
</task>

<task type="auto">
  <name>Task 2: Create Boot Test Checklist Template</name>
  <files>docs/BOOT-TEST-CHECKLIST.md</files>
  <action>
Create boot test tracking template at `docs/BOOT-TEST-CHECKLIST.md`:

```markdown
# Boot Test Checklist - NanoPi M6 U-Boot Bring-Up

## Overview

This document tracks boot attempts during U-Boot bring-up. Without UART, we rely on:
- **LED activity** in first 10 seconds (indicates SPL/DDR success)
- **HDMI output** after ~60-120 seconds (indicates kernel boot - U-Boot has NO video output)
- **Network connectivity** after expected boot time

**Critical Note:** Mainline U-Boot does NOT have HDMI/video support for RK3588. Any display output means the KERNEL has booted, not just U-Boot.

## Iteration Strategy

Based on research recommendations, follow this order:

### Tier 1: Quick Iterations (3 attempts max)
1. `nanopi-r6c-rk3588s_defconfig` with DDR v1.16, BL31 v1.45
2. `nanopi-r6c-rk3588s_defconfig` with DDR v1.19, BL31 v1.51 (if blobs updated)
3. `nanopi-r6s-rk3588s_defconfig` as alternative

### Tier 2: Configuration Investigation (2 attempts max)
4. Extract and analyze Armbian M6 defconfig differences
5. Apply specific Armbian patches to R6C defconfig

### Tier 3: Decision Point
- If 5 attempts fail with no LED activity: Consider parking phase or acquiring UART
- If LED activity observed but no kernel: Continue debugging (U-Boot working, kernel issue)

## Boot Attempt Log

---

### Attempt #1

**Date/Time:** ____________________

**Configuration:**
- Defconfig: `nanopi-r6c-rk3588s_defconfig`
- DDR blob: `rk3588_ddr_lp4_2112MHz_lp5_2400MHz_v1.16.bin`
- BL31: `rk3588_bl31_v1.45.elf`
- SD card: ____________________

**Observation Timeline:**

| Time | Check | Observed |
|------|-------|----------|
| 0-10s | Power LED on? | [ ] Yes [ ] No |
| 0-10s | Any LED blink/activity? | [ ] Yes [ ] No - Describe: _______ |
| 10-30s | LED patterns change? | [ ] Yes [ ] No - Describe: _______ |
| 30-60s | HDMI signal detected? | [ ] Yes [ ] No |
| 60-120s | Any HDMI output? | [ ] Yes [ ] No - Describe: _______ |
| 120s+ | Network DHCP lease? | [ ] Yes [ ] No - IP: _______ |

**Result:**
- [ ] **SUCCESS** - HDMI shows kernel/Talos output
- [ ] **PARTIAL** - LED activity but no HDMI (U-Boot may work, kernel issue)
- [ ] **FAILURE** - No LED activity, no HDMI, no network

**Notes:**
_________________________________________________
_________________________________________________

**Next Action:**
_________________________________________________

---

### Attempt #2

**Date/Time:** ____________________

**Configuration:**
- Defconfig: ____________________
- DDR blob: ____________________
- BL31: ____________________
- SD card: ____________________

**Observation Timeline:**

| Time | Check | Observed |
|------|-------|----------|
| 0-10s | Power LED on? | [ ] Yes [ ] No |
| 0-10s | Any LED blink/activity? | [ ] Yes [ ] No - Describe: _______ |
| 10-30s | LED patterns change? | [ ] Yes [ ] No - Describe: _______ |
| 30-60s | HDMI signal detected? | [ ] Yes [ ] No |
| 60-120s | Any HDMI output? | [ ] Yes [ ] No - Describe: _______ |
| 120s+ | Network DHCP lease? | [ ] Yes [ ] No - IP: _______ |

**Result:**
- [ ] **SUCCESS** - HDMI shows kernel/Talos output
- [ ] **PARTIAL** - LED activity but no HDMI
- [ ] **FAILURE** - No LED activity, no HDMI, no network

**Notes:**
_________________________________________________
_________________________________________________

**Next Action:**
_________________________________________________

---

### Attempt #3

**Date/Time:** ____________________

**Configuration:**
- Defconfig: ____________________
- DDR blob: ____________________
- BL31: ____________________
- SD card: ____________________

**Observation Timeline:**

| Time | Check | Observed |
|------|-------|----------|
| 0-10s | Power LED on? | [ ] Yes [ ] No |
| 0-10s | Any LED blink/activity? | [ ] Yes [ ] No - Describe: _______ |
| 10-30s | LED patterns change? | [ ] Yes [ ] No - Describe: _______ |
| 30-60s | HDMI signal detected? | [ ] Yes [ ] No |
| 60-120s | Any HDMI output? | [ ] Yes [ ] No - Describe: _______ |
| 120s+ | Network DHCP lease? | [ ] Yes [ ] No - IP: _______ |

**Result:**
- [ ] **SUCCESS** - HDMI shows kernel/Talos output
- [ ] **PARTIAL** - LED activity but no HDMI
- [ ] **FAILURE** - No LED activity, no HDMI, no network

**Notes:**
_________________________________________________
_________________________________________________

**Next Action:**
_________________________________________________

---

## Success Indicators

### DDR/SPL Success (First 10 seconds)
- LED blinks or changes pattern = DDR training completed, SPL running
- No LED activity = DDR blob or SPL issue

### U-Boot Success (10-60 seconds)
- Cannot directly observe (no HDMI output from U-Boot)
- Inferred from kernel boot success

### Kernel Boot Success (60-120 seconds)
- HDMI displays output = Kernel booted, display driver working
- Network responds to ping = Full boot successful

## Recovery Reference

If boot fails completely:
1. See [MaskROM Recovery](MASKROM-RECOVERY.md)
2. Verify hardware with Armbian SD card (known working from Phase 1)
3. Document failure mode before trying new configuration

---

*Part of Phase 2: Bootloader Bring-Up*
*See also: [MaskROM Recovery](MASKROM-RECOVERY.md), [Flash Workflow](FLASH-WORKFLOW.md)*
```
  </action>
  <verify>File exists and contains observation timeline template</verify>
  <done>Boot test checklist created with LED-based verification focus</done>
</task>

</tasks>

<verification>
1. MaskROM doc exists: `ls docs/MASKROM-RECOVERY.md`
2. Contains rkdeveloptool: `grep "rkdeveloptool" docs/MASKROM-RECOVERY.md`
3. Checklist exists: `ls docs/BOOT-TEST-CHECKLIST.md`
4. Contains iteration strategy: `grep "Tier 1" docs/BOOT-TEST-CHECKLIST.md`
</verification>

<success_criteria>
- [ ] `docs/MASKROM-RECOVERY.md` exists with complete recovery procedure
- [ ] MaskROM doc includes macOS-specific rkdeveloptool installation
- [ ] `docs/BOOT-TEST-CHECKLIST.md` exists with observation timeline template
- [ ] Checklist acknowledges U-Boot has no HDMI output capability
- [ ] Both docs cross-reference each other
</success_criteria>

<output>
After completion, create `.planning/phases/02-bootloader/02-02-SUMMARY.md`
</output>
