---
phase: 02-bootloader
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - _out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin
autonomous: false

must_haves:
  truths:
    - "U-Boot binary for NanoPi M6 compiles without errors"
    - "Binary can be flashed to SD card using existing flash.sh script"
    - "NanoPi M6 shows boot activity (LED or HDMI) with new U-Boot"
  artifacts:
    - path: "_out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin"
      provides: "Compiled U-Boot binary for NanoPi M6"
  key_links:
    - from: "artifacts/u-boot/nanopi-m6/pkg.yaml"
      to: "_out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin"
      via: "bldr build"
      pattern: "u-boot-rockchip.bin"
    - from: "_out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin"
      to: "SD card sector 64"
      via: "hack/flash.sh"
      pattern: "seek=64"
---

<objective>
Build U-Boot for NanoPi M6 and verify boot

Purpose: Compile the U-Boot configuration created in Plan 01 and test on actual hardware. This is the critical validation step - either we get boot activity or we iterate on configuration.

Output:
- Compiled `u-boot-rockchip.bin` for NanoPi M6
- First boot attempt documented in checklist
- Success or documented failure mode for iteration
</objective>

<execution_context>
@/Users/johnsonhuynh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johnsonhuynh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-bootloader/02-CONTEXT.md
@.planning/phases/02-bootloader/02-RESEARCH.md

# Reference build and flash workflows
@Makefile
@hack/flash.sh
@docs/FLASH-WORKFLOW.md
@docs/BOOT-TEST-CHECKLIST.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build U-Boot for NanoPi M6</name>
  <files>_out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin</files>
  <action>
Build the NanoPi M6 U-Boot using the local build target.

First, verify the pkg.yaml is in place:
```bash
ls artifacts/u-boot/nanopi-m6/pkg.yaml
```

Then run the build (this may take 10-30 minutes):
```bash
make local-talos-sbc-rk3588-mainline DEST=_out
```

This builds all targets including the new nanopi-m6. The build will:
1. Pull U-Boot source from Collabora fork
2. Apply nanopi-r6c-rk3588s_defconfig
3. Compile with correct DDR blob and BL31
4. Output to `_out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin`

After build completes, verify output:
```bash
ls -la _out/artifacts/arm64/u-boot/nanopi-m6/
file _out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin
```

Expected: Binary file, approximately 1-4 MB in size.

**If build fails:**
- Check build logs for defconfig errors
- Verify nanopi-r6c-rk3588s_defconfig exists in Collabora U-Boot fork
- If defconfig missing, may need to try alternative (nanopi-r6s-rk3588s_defconfig)
  </action>
  <verify>
`ls _out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin` returns file
`file _out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin` shows "data" or "executable"
  </verify>
  <done>u-boot-rockchip.bin exists and is a valid binary (non-zero size)</done>
</task>

<task type="auto">
  <name>Task 2: Prepare SD card with U-Boot image</name>
  <files>SD card (external)</files>
  <action>
Flash the compiled U-Boot to an SD card for testing.

1. Insert a microSD card (can reuse the Armbian test card from Phase 1)

2. Identify the SD card:
```bash
diskutil list
```
Look for external disk matching SD card size (e.g., /dev/disk2)

3. Flash using the existing flash script:
```bash
./hack/flash.sh _out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin
```

The script will:
- Prompt for disk selection (VERIFY CAREFULLY - don't overwrite internal disk!)
- Unmount the disk
- Write u-boot-rockchip.bin at sector 64 (correct offset for Rockchip)
- Sync and eject

**Important:** This writes ONLY the bootloader. For a full boot test, the SD card should have Armbian partitions (kernel, rootfs) from Phase 1. The U-Boot we're writing should then load that kernel.

**Alternative if flash.sh doesn't work:**
```bash
diskutil unmountDisk /dev/diskN
sudo dd if=_out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin of=/dev/rdiskN seek=64 bs=512 status=progress
sync
diskutil eject /dev/diskN
```
  </action>
  <verify>flash.sh completes without errors, disk ejected successfully</verify>
  <done>SD card prepared with NanoPi M6 U-Boot at sector 64</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify boot on NanoPi M6 hardware</name>
  <what-built>
U-Boot binary for NanoPi M6 using nanopi-r6c-rk3588s_defconfig, flashed to SD card at sector 64.

**Critical context:** Mainline U-Boot has NO HDMI output for RK3588. Success means:
- LED activity in first 10 seconds (DDR/SPL working)
- Eventually kernel boots and shows HDMI output (if SD card has Armbian kernel)
  </what-built>
  <how-to-verify>
**Follow the Boot Test Checklist (docs/BOOT-TEST-CHECKLIST.md):**

1. **Prepare:**
   - Have the SD card with new U-Boot ready
   - Connect HDMI cable to display
   - Have stopwatch/timer ready
   - Open router DHCP lease page (optional but helpful)

2. **Boot test:**
   - Insert SD card into NanoPi M6
   - Connect power
   - Start timer immediately

3. **Observe (2 minute window):**

   | Time | What to Watch |
   |------|---------------|
   | 0-10s | Power LED behavior - any blinking? |
   | 0-10s | Other LED activity? |
   | 10-30s | LED pattern changes? |
   | 30-60s | HDMI signal detected by monitor? |
   | 60-120s | Any display output? |
   | 120s | Check network for new DHCP lease |

4. **Record results** in docs/BOOT-TEST-CHECKLIST.md (Attempt #1)

**Success criteria:**
- ANY of these indicates progress:
  - LED blinks/activity in first 10 seconds = DDR/SPL working
  - HDMI output appears = Kernel booted (U-Boot worked!)
  - Network responds = Full boot successful

**Failure indicators:**
- No LED activity at all = DDR blob or SPL issue
- LED activity but no HDMI after 2 min = U-Boot may work, kernel/display issue

5. **If total failure (no LED activity):**
   - Verify hardware with Armbian SD card from Phase 1
   - If Armbian works, issue is with our U-Boot config
   - Document and prepare for iteration (different defconfig)
  </how-to-verify>
  <resume-signal>
Respond with one of:
- "SUCCESS: [describe what you saw]" - if any boot activity observed
- "PARTIAL: [describe LED activity]" - if LED but no HDMI
- "FAILURE: [observations]" - if no activity at all
- "HARDWARE_ISSUE: [details]" - if Armbian also fails (hardware problem)
  </resume-signal>
</task>

</tasks>

<verification>
1. Build output exists: `ls _out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin`
2. Binary is valid: `file _out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin`
3. Flash completed: Script exits cleanly
4. Hardware test: User reports boot activity
</verification>

<success_criteria>
- [ ] U-Boot compiles successfully for nanopi-m6 target
- [ ] Binary flashed to SD card at correct offset (sector 64)
- [ ] Hardware test shows boot activity (LED or HDMI output)
- [ ] Boot attempt documented in checklist
</success_criteria>

<output>
After completion, create `.planning/phases/02-bootloader/02-03-SUMMARY.md`

**Note:** If boot fails, the summary should document:
- Exact configuration used
- Observed behavior (or lack thereof)
- Proposed next iteration (different defconfig or blob versions)
- Whether to create a gap closure plan for iteration
</output>
