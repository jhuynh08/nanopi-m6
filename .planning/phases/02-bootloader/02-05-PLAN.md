---
phase: 02-bootloader
plan: 05
type: execute
wave: 2
depends_on: ["02-04"]
files_modified:
  - artifacts/u-boot/nanopi-m6/pkg.yaml
  - docs/BOOT-TEST-CHECKLIST.md
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "U-Boot binary compiles with M6-specific defconfig"
    - "DDR memory initializes on NanoPi M6 hardware"
    - "BL31 loads successfully (verified via boot stage progression)"
    - "Boot activity observable (LED blink or kernel reaching HDMI)"
  artifacts:
    - path: "artifacts/u-boot/nanopi-m6/pkg.yaml"
      provides: "Updated build config with M6-specific defconfig"
      contains: "nanopi-m6"
    - path: "_out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin"
      provides: "Compiled U-Boot binary with correct config"
  key_links:
    - from: "artifacts/u-boot/nanopi-m6/pkg.yaml"
      to: "defconfig"
      via: "make defconfig command"
      pattern: "nanopi.*m6|CONFIG_TARGET_NANOPI"
    - from: "_out/.../u-boot-rockchip.bin"
      to: "SD card"
      via: "hack/flash.sh"
      pattern: "flash.sh.*bootloader"
---

<objective>
Apply NanoPi M6-specific U-Boot configuration extracted in Plan 02-04, rebuild U-Boot, and verify boot on hardware. This closes the Phase 2 gap: achieving observable boot activity on NanoPi M6.

Purpose: Replace the non-working rock5a defconfig with M6-specific configuration to enable DDR training and successful boot.

Output: Working U-Boot that boots on NanoPi M6 hardware with observable LED activity.
</objective>

<execution_context>
@/Users/johnsonhuynh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johnsonhuynh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-bootloader/02-04-SUMMARY.md
@docs/ARMBIAN-UBOOT-ANALYSIS.md
@artifacts/u-boot/nanopi-m6/defconfig.diff
@docs/BOOT-TEST-CHECKLIST.md
@docs/MASKROM-RECOVERY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update U-Boot Build Configuration</name>
  <files>artifacts/u-boot/nanopi-m6/pkg.yaml</files>
  <action>
Update pkg.yaml with NanoPi M6-specific configuration based on Plan 02-04 analysis.

**DECISION TREE - Read docs/ARMBIAN-UBOOT-ANALYSIS.md and apply based on "Recommended Option":**

**IF Recommended Option is "A: Use Custom Defconfig":**
1. Copy the defconfig file to `artifacts/u-boot/nanopi-m6/defconfig`
2. Update pkg.yaml prepare section:
   ```yaml
   prepare:
     - name: configure
       command: |
         cp ../../defconfig .config
         make olddefconfig
   ```
3. Remove the `make rock5a-rk3588s_defconfig` line

**ELSE IF Recommended Option is "B: Apply Patches":**
1. Copy patches to `artifacts/u-boot/nanopi-m6/patches/`
2. Update pkg.yaml prepare section:
   ```yaml
   prepare:
     - name: apply-patches
       command: |
         for p in ../../patches/*.patch; do
           git apply "$p"
         done
     - name: configure
       command: make [defconfig-name-from-analysis]_defconfig
   ```

**ELSE IF Recommended Option is "C: Patch rock5a Defconfig":**
1. Keep `make rock5a-rk3588s_defconfig`
2. Add sed commands after defconfig to modify specific CONFIG options:
   ```yaml
   prepare:
     - name: configure
       command: |
         make rock5a-rk3588s_defconfig
         # Apply M6-specific changes from analysis
         sed -i 's/CONFIG_OLD=y/CONFIG_NEW=y/' .config
         [additional sed commands per analysis]
         make olddefconfig
   ```

**ALSO check DDR/BL31 blob versions:**
- IF ARMBIAN-UBOOT-ANALYSIS.md recommends different blob versions:
  - Update ROCKCHIP_TPL path (DDR blob)
  - Update BL31 path
- ELSE keep existing blob versions (v1.16 DDR, v1.45 BL31)

**FINALLY:**
- Remove the comment about rock5a workaround
- Ensure YAML syntax is valid

DO NOT:
- Change the overall pkg.yaml structure (keep bldr/kres compatibility)
- Remove debug CFLAGS (still needed for boot troubleshooting)
  </action>
  <verify>
```bash
# Verify pkg.yaml no longer references rock5a
! grep -q "rock5a" artifacts/u-boot/nanopi-m6/pkg.yaml && \
  echo "PASS: No rock5a reference" || echo "FAIL: Still references rock5a"

# Verify YAML syntax is valid
python3 -c "import yaml; yaml.safe_load(open('artifacts/u-boot/nanopi-m6/pkg.yaml'))" && \
  echo "PASS: Valid YAML" || echo "FAIL: Invalid YAML syntax"

# Verify contains M6-specific config reference
grep -qE "nanopi.*m6|defconfig|CONFIG_" artifacts/u-boot/nanopi-m6/pkg.yaml && \
  echo "PASS: Contains M6 config" || echo "FAIL: Missing M6 config"
```
  </verify>
  <done>
U-Boot pkg.yaml updated with NanoPi M6-specific defconfig. Ready for build.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build and Flash U-Boot</name>
  <files>_out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin</files>
  <action>
Build U-Boot with updated configuration and flash to SD card.

1. Build U-Boot for NanoPi M6:
   ```bash
   make local-talos-sbc-rk3588-mainline DEST=_out TARGET=u-boot-nanopi-m6
   ```
   (or equivalent command from build system)

2. Verify binary produced:
   - Check _out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin exists
   - Verify file size is reasonable (should be ~8-10MB)

3. Flash to SD card:
   ```bash
   ./hack/flash.sh --bootloader --device /dev/diskN
   ```
   (user will confirm device path)

DO NOT:
- Flash to eMMC (SD card only during Phase 2)
- Skip the build verification step
  </action>
  <verify>
```bash
# Build completes without error - checked by exit code of make command

# Verify binary exists
test -f _out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin && \
  echo "PASS: Binary exists" || echo "FAIL: Binary not found"

# Verify binary size is reasonable (between 5MB and 15MB)
SIZE=$(stat -f%z _out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin 2>/dev/null || stat -c%s _out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin)
[ "$SIZE" -gt 5000000 ] && [ "$SIZE" -lt 15000000 ] && \
  echo "PASS: Binary size reasonable ($SIZE bytes)" || echo "FAIL: Binary size unexpected ($SIZE bytes)"
```
  </verify>
  <done>
U-Boot binary built with M6-specific config and flashed to SD card. Ready for hardware test.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>U-Boot binary with NanoPi M6-specific configuration from Armbian analysis</what-built>
  <how-to-verify>
Boot test procedure (per docs/BOOT-TEST-CHECKLIST.md):

1. Insert SD card into NanoPi M6
2. Connect power and observe for 2 minutes
3. Record observations at each interval:
   - 0-10 seconds: LED activity? (SYS LED beyond power-on glow)
   - 10-30 seconds: LED blinking pattern?
   - 30-60 seconds: HDMI output? (even text mode)
   - 60-120 seconds: Network activity? (check DHCP lease)

**BOOT STAGE VERIFICATION (for BOOT-02 BL31 requirement):**

Boot stages progress: TPL (DDR init) -> SPL -> BL31 (ATF) -> U-Boot proper

Indicators of stage progression:
- **TPL success (DDR init):** LED shows ANY activity beyond power glow
- **SPL success:** LED blink pattern changes OR continues blinking
- **BL31 success (ATF):** Boot progresses past 5 seconds with LED activity
- **U-Boot success:** HDMI output OR network DHCP lease

If LED blinks but stops after 5 seconds: SPL loaded but BL31 failed
If LED blinks continuously but no HDMI after 2 min: U-Boot running but display init failed

**SUCCESS indicators (any of these = Phase 2 complete):**
- LED blink pattern different from power-only glow (DDR init success)
- HDMI output (even just text/logo) (full boot success)
- Network DHCP lease acquired (full boot success)

**FAILURE indicators (all must be true to fail):**
- SYS LED only shows power (no activity blink)
- No HDMI output after 2 minutes
- No network activity

4. Update docs/BOOT-TEST-CHECKLIST.md with Attempt #2 results

**If SUCCESS:** Type "approved" and describe observations
**If FAILURE:**
  - Describe what was observed and any differences from Attempt #1
  - Test MaskROM recovery: Hold Mask button, connect USB, verify `rkdeveloptool ld` detects device
  - This confirms recovery path works (per docs/MASKROM-RECOVERY.md)
  </how-to-verify>
  <resume-signal>Type "approved" with observations, or describe boot failure details (including MaskROM recovery test result)</resume-signal>
</task>

</tasks>

<verification>
- [ ] artifacts/u-boot/nanopi-m6/pkg.yaml updated with M6-specific config
- [ ] U-Boot binary builds without errors
- [ ] Binary flashed to SD card
- [ ] Hardware boot test completed
- [ ] docs/BOOT-TEST-CHECKLIST.md updated with Attempt #2 results
- [ ] If failed: MaskROM recovery tested (rkdeveloptool ld detects device)
</verification>

<success_criteria>
**Phase 2 Goal Complete when:**
- NanoPi M6 shows boot activity (LED blink OR HDMI output OR network activity)
- This confirms DDR initialization succeeded (BOOT-03)
- Boot progression past 5 seconds with LED activity confirms BL31 loaded (BOOT-02)
- U-Boot is functional, ready for Phase 3 (Kernel Integration)

**Phase 2 Success Criteria #4 (Recovery procedure tested):**
- If boot succeeds: Recovery testing deferred (not needed)
- If boot fails: MaskROM recovery tested as part of checkpoint verification
</success_criteria>

<output>
After completion, create `.planning/phases/02-bootloader/02-05-SUMMARY.md`

If boot succeeds: Mark Phase 2 complete, ready for Phase 3.
If boot fails: Document observations for Tier 2/3 iteration strategy. Include MaskROM recovery test result.
</output>
