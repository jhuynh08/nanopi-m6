---
phase: 02-bootloader
plan: 05
type: execute
wave: 2
depends_on: ["02-04"]
files_modified:
  - artifacts/u-boot/nanopi-m6/pkg.yaml
  - docs/BOOT-TEST-CHECKLIST.md
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "U-Boot binary compiles with M6-specific defconfig"
    - "DDR memory initializes on NanoPi M6 hardware"
    - "Boot activity observable (LED blink or kernel reaching HDMI)"
  artifacts:
    - path: "artifacts/u-boot/nanopi-m6/pkg.yaml"
      provides: "Updated build config with M6-specific defconfig"
      contains: "nanopi-m6"
    - path: "_out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin"
      provides: "Compiled U-Boot binary with correct config"
  key_links:
    - from: "artifacts/u-boot/nanopi-m6/pkg.yaml"
      to: "defconfig"
      via: "make defconfig command"
      pattern: "nanopi.*m6|CONFIG_TARGET_NANOPI"
    - from: "_out/.../u-boot-rockchip.bin"
      to: "SD card"
      via: "hack/flash.sh"
      pattern: "flash.sh.*bootloader"
---

<objective>
Apply NanoPi M6-specific U-Boot configuration extracted in Plan 02-04, rebuild U-Boot, and verify boot on hardware. This closes the Phase 2 gap: achieving observable boot activity on NanoPi M6.

Purpose: Replace the non-working rock5a defconfig with M6-specific configuration to enable DDR training and successful boot.

Output: Working U-Boot that boots on NanoPi M6 hardware with observable LED activity.
</objective>

<execution_context>
@/Users/johnsonhuynh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johnsonhuynh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-bootloader/02-04-SUMMARY.md
@docs/ARMBIAN-UBOOT-ANALYSIS.md
@artifacts/u-boot/nanopi-m6/defconfig.diff
@docs/BOOT-TEST-CHECKLIST.md
@docs/MASKROM-RECOVERY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update U-Boot Build Configuration</name>
  <files>artifacts/u-boot/nanopi-m6/pkg.yaml</files>
  <action>
Update pkg.yaml with NanoPi M6-specific configuration based on Plan 02-04 analysis.

Apply the defconfig changes identified in docs/ARMBIAN-UBOOT-ANALYSIS.md:

1. Update the defconfig line:
   - Replace `make rock5a-rk3588s_defconfig` with the correct M6 defconfig
   - If using patches: add patch application step before defconfig
   - If using custom defconfig file: copy it from artifacts/u-boot/nanopi-m6/

2. Update DDR/BL31 blob versions if needed:
   - Check if ARMBIAN-UBOOT-ANALYSIS.md recommends different blob versions
   - Update ROCKCHIP_TPL and BL31 paths as required

3. Add any required patch steps:
   - If Armbian uses U-Boot patches, add them to the prepare step
   - Store patches in artifacts/u-boot/nanopi-m6/patches/

4. Remove the comment about rock5a workaround

DO NOT:
- Change the overall pkg.yaml structure (keep bldr/kres compatibility)
- Remove debug CFLAGS (still needed for boot troubleshooting)
  </action>
  <verify>
- artifacts/u-boot/nanopi-m6/pkg.yaml no longer references rock5a
- pkg.yaml uses M6-specific defconfig or custom config
- YAML syntax is valid: `python3 -c "import yaml; yaml.safe_load(open('artifacts/u-boot/nanopi-m6/pkg.yaml'))"`
  </verify>
  <done>
U-Boot pkg.yaml updated with NanoPi M6-specific defconfig. Ready for build.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build and Flash U-Boot</name>
  <files>_out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin</files>
  <action>
Build U-Boot with updated configuration and flash to SD card.

1. Build U-Boot for NanoPi M6:
   ```bash
   make local-talos-sbc-rk3588-mainline DEST=_out TARGET=u-boot-nanopi-m6
   ```
   (or equivalent command from build system)

2. Verify binary produced:
   - Check _out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin exists
   - Verify file size is reasonable (should be ~8-10MB)

3. Flash to SD card:
   ```bash
   ./hack/flash.sh --bootloader --device /dev/diskN
   ```
   (user will confirm device path)

DO NOT:
- Flash to eMMC (SD card only during Phase 2)
- Skip the build verification step
  </action>
  <verify>
- Build command completes without error
- _out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin exists
- Binary size is reasonable (~8-10MB)
- Flash command completes successfully
  </verify>
  <done>
U-Boot binary built with M6-specific config and flashed to SD card. Ready for hardware test.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>U-Boot binary with NanoPi M6-specific configuration from Armbian analysis</what-built>
  <how-to-verify>
Boot test procedure (per docs/BOOT-TEST-CHECKLIST.md):

1. Insert SD card into NanoPi M6
2. Connect power and observe for 2 minutes
3. Record observations at each interval:
   - 0-10 seconds: LED activity? (SYS LED beyond power-on glow)
   - 10-30 seconds: LED blinking pattern?
   - 30-60 seconds: HDMI output? (even text mode)
   - 60-120 seconds: Network activity? (check DHCP lease)

**SUCCESS indicators (any of these):**
- LED blink pattern different from power-only glow
- HDMI output (even just text/logo)
- Network DHCP lease acquired

**FAILURE indicators (all must be true to fail):**
- SYS LED only shows power (no activity blink)
- No HDMI output after 2 minutes
- No network activity

4. Update docs/BOOT-TEST-CHECKLIST.md with Attempt #2 results

**If SUCCESS:** Type "approved" and describe observations
**If FAILURE:** Describe what was observed and any differences from Attempt #1
  </how-to-verify>
  <resume-signal>Type "approved" with observations, or describe boot failure details</resume-signal>
</task>

</tasks>

<verification>
- [ ] artifacts/u-boot/nanopi-m6/pkg.yaml updated with M6-specific config
- [ ] U-Boot binary builds without errors
- [ ] Binary flashed to SD card
- [ ] Hardware boot test completed
- [ ] docs/BOOT-TEST-CHECKLIST.md updated with Attempt #2 results
</verification>

<success_criteria>
**Phase 2 Goal Complete when:**
- NanoPi M6 shows boot activity (LED blink OR HDMI output OR network activity)
- This confirms DDR initialization succeeded
- U-Boot is functional, ready for Phase 3 (Kernel Integration)
</success_criteria>

<output>
After completion, create `.planning/phases/02-bootloader/02-05-SUMMARY.md`

If boot succeeds: Mark Phase 2 complete, ready for Phase 3.
If boot fails: Document observations for Tier 2/3 iteration strategy.
</output>
