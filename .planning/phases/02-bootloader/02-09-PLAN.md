---
phase: 02-bootloader
plan: 09
type: execute
wave: 1
depends_on: []
files_modified:
  - Pkgfile
  - artifacts/u-boot/nanopi-m6/pkg.yaml
  - artifacts/u-boot/prepare/pkg.yaml
  - docs/BOOT-TEST-CHECKLIST.md
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "Vendor U-Boot source builds successfully in bldr pipeline"
    - "MiniLoaderAll.bin + uboot.img format produced (not u-boot-rockchip.bin)"
    - "Boot test Attempt #6 shows LED activity (replicates Attempt #5 success)"
  artifacts:
    - path: "Pkgfile"
      provides: "FriendlyELEC uboot-rockchip source reference"
      contains: "friendlyelec_uboot"
    - path: "artifacts/u-boot/nanopi-m6/pkg.yaml"
      provides: "Vendor U-Boot build configuration"
      contains: "nanopi6_defconfig"
    - path: "_out/artifacts/arm64/u-boot/nanopi-m6/idbloader.img"
      provides: "Vendor-format bootloader stage 1"
    - path: "_out/artifacts/arm64/u-boot/nanopi-m6/uboot.img"
      provides: "Vendor-format bootloader stage 2"
  key_links:
    - from: "Pkgfile"
      to: "FriendlyELEC/uboot-rockchip"
      via: "friendlyelec_uboot_ref variable"
      pattern: "friendlyelec.*uboot"
    - from: "artifacts/u-boot/nanopi-m6/pkg.yaml"
      to: "nanopi6_defconfig"
      via: "make defconfig command"
      pattern: "nanopi6_defconfig"
    - from: "build output"
      to: "idbloader.img + uboot.img"
      via: "Rockchip mkimage tools"
      pattern: "idbloader|uboot\\.img"
---

<objective>
Integrate FriendlyELEC vendor U-Boot (v2017.09) into the Talos build system to produce bootable NanoPi M6 bootloader.

Purpose: Phase 2 root cause analysis proved mainline U-Boot format (u-boot-rockchip.bin) is incompatible with NanoPi M6. The FriendlyELEC vendor bootloader successfully boots on identical hardware (Attempt #5). This plan integrates the vendor U-Boot source to produce the required MiniLoaderAll format.

Output: Working vendor U-Boot build producing idbloader.img + uboot.img that boots on NanoPi M6 hardware.
</objective>

<execution_context>
@/Users/johnsonhuynh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johnsonhuynh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-bootloader/02-08-SUMMARY.md

# Prior work to reference
@Pkgfile
@artifacts/u-boot/nanopi-m6/pkg.yaml
@artifacts/u-boot/prepare/pkg.yaml
@docs/FRIENDLYELEC-BOOTLOADER-EXTRACTION.md
@docs/BOOT-TEST-CHECKLIST.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add FriendlyELEC U-Boot source to Pkgfile and create vendor prepare stage</name>
  <files>
    - Pkgfile
    - artifacts/u-boot/prepare-vendor/pkg.yaml (new)
  </files>
  <action>
**Update Pkgfile to add FriendlyELEC uboot-rockchip source:**

Add new variables for FriendlyELEC vendor U-Boot after the existing uboot variables:

```yaml
vars:
  # ... existing mainline uboot vars ...

  # FriendlyELEC vendor U-Boot for NanoPi M6
  # Required because mainline u-boot-rockchip.bin format does not boot on NanoPi M6
  # Source: https://github.com/FriendlyELEC/uboot-rockchip
  # Branch: nanopi6-v2017.09
  friendlyelec_uboot_ref: nanopi6-v2017.09
  friendlyelec_uboot_repo: https://github.com/FriendlyELEC/uboot-rockchip
```

Note: FriendlyELEC uses branch references, not tags. The nanopi6-v2017.09 branch contains NanoPi M6 support.

**Create new artifacts/u-boot/prepare-vendor/pkg.yaml:**

```yaml
name: u-boot-prepare-vendor
variant: scratch
shell: /toolchain/bin/bash
dependencies:
  - stage: base
steps:
  - sources:
      - url: https://github.com/FriendlyELEC/uboot-rockchip/archive/refs/heads/nanopi6-v2017.09.tar.gz
        destination: uboot-vendor.tar.gz
        # Note: Branch archive - no checksum pinning (branch can update)
    prepare:
      - |
        mkdir -p /usr/bin \
          && ln -sf /toolchain/bin/env /usr/bin/env \
          && ln -sf /toolchain/bin/python3 /toolchain/bin/python

        pip3 install pyelftools setuptools

        tar xf uboot-vendor.tar.gz --strip-components=1
    install:
      - |
        mkdir -p /src-vendor
        cp -a . /src-vendor/
finalize:
  - from: /src-vendor
    to: /src-vendor
  - from: /toolchain
    to: /toolchain
  - from: /usr
    to: /usr
  - from: /bin
    to: /bin
  - from: /lib
    to: /lib
```

**Why vendor U-Boot v2017.09:**
- FriendlyELEC forked at v2017.09 with Rockchip vendor patches
- Contains proprietary idbloader generation for RK3588S
- Produces MiniLoaderAll format that boots on NanoPi M6
- Mainline U-Boot v2025.10 produces u-boot-rockchip.bin format that does NOT boot
  </action>
  <verify>
```bash
# Verify Pkgfile has FriendlyELEC variables
grep -E "friendlyelec_uboot" Pkgfile

# Verify prepare-vendor pkg.yaml exists
cat artifacts/u-boot/prepare-vendor/pkg.yaml | head -20

# Verify source URL is correct
grep "FriendlyELEC/uboot-rockchip" artifacts/u-boot/prepare-vendor/pkg.yaml
```
  </verify>
  <done>Pkgfile contains friendlyelec_uboot_ref variable. New prepare-vendor/pkg.yaml exists with FriendlyELEC source archive.</done>
</task>

<task type="auto">
  <name>Task 2: Update nanopi-m6 pkg.yaml to build vendor U-Boot with Rockchip format</name>
  <files>
    - artifacts/u-boot/nanopi-m6/pkg.yaml
  </files>
  <action>
**Replace the existing pkg.yaml to build from vendor source:**

The key differences from mainline:
1. Use `u-boot-prepare-vendor` stage (not `u-boot-prepare`)
2. Use `nanopi6_defconfig` (FriendlyELEC defconfig, not Armbian's nanopi-m6-rk3588s)
3. Output `idbloader.img` + `uboot.img` (not `u-boot-rockchip.bin`)
4. Use FriendlyELEC's build process which invokes Rockchip tools internally

**New artifacts/u-boot/nanopi-m6/pkg.yaml:**

```yaml
name: u-boot-nanopi-m6
variant: scratch
shell: /toolchain/bin/bash
dependencies:
  - stage: rkbin
  - stage: u-boot-prepare-vendor
steps:
  - env:
      SOURCE_DATE_EPOCH: {{ .BUILD_ARG_SOURCE_DATE_EPOCH }}
      # FriendlyELEC vendor U-Boot uses different blob integration
      # Blobs are bundled during idbloader generation
    prepare:
      - |
        cd /src-vendor

        # FriendlyELEC's nanopi6_defconfig targets NanoPi M6 (RK3588S)
        # This is the exact defconfig that produced working Attempt #5 bootloader
        make nanopi6_defconfig
    build:
      - |
        cd /src-vendor

        # Build vendor U-Boot
        # FriendlyELEC build process generates idbloader.img and uboot.img
        make -j $(nproc)

        # The vendor build system creates:
        # - idbloader.img (TPL + SPL in Rockchip format)
        # - uboot.img (U-Boot proper + DTB in FIT format)
        # These are written to SD card at different offsets than combined u-boot-rockchip.bin
    install:
      - |
        mkdir -p /rootfs/artifacts/arm64/u-boot/nanopi-m6

        # Copy vendor-format bootloader components
        # idbloader.img goes at sector 64 (0x8000 = 32KB)
        # uboot.img goes at sector 16384 (0x800000 = 8MB)
        cp -v /src-vendor/idbloader.img /rootfs/artifacts/arm64/u-boot/nanopi-m6/
        cp -v /src-vendor/uboot.img /rootfs/artifacts/arm64/u-boot/nanopi-m6/

        # Also copy trust.img if generated (ATF/OP-TEE)
        [ -f /src-vendor/trust.img ] && cp -v /src-vendor/trust.img /rootfs/artifacts/arm64/u-boot/nanopi-m6/ || true
finalize:
  - from: /rootfs
    to: /rootfs
```

**Critical format differences:**
| Aspect | Mainline (BROKEN) | Vendor (WORKING) |
|--------|-------------------|------------------|
| Output files | u-boot-rockchip.bin | idbloader.img + uboot.img |
| Flash offset | Single file at sector 64 | Two files at sectors 64 and 16384 |
| DDR init | Built-in TPL | Rockchip proprietary idbloader |
| Defconfig | nanopi-m6-rk3588s | nanopi6_defconfig |

**Why this works:**
- FriendlyELEC's build system uses Rockchip's proprietary tools to generate idbloader.img
- The idbloader contains the DDR training code in Rockchip's expected format
- This is the exact same format that boots in Attempt #5
  </action>
  <verify>
```bash
# Verify pkg.yaml uses vendor prepare stage
grep "u-boot-prepare-vendor" artifacts/u-boot/nanopi-m6/pkg.yaml

# Verify defconfig is vendor's nanopi6
grep "nanopi6_defconfig" artifacts/u-boot/nanopi-m6/pkg.yaml

# Verify output files are idbloader.img and uboot.img
grep -E "idbloader|uboot\.img" artifacts/u-boot/nanopi-m6/pkg.yaml

# Build the vendor U-Boot (this validates the entire pipeline)
make artifacts/u-boot/nanopi-m6
```
  </verify>
  <done>pkg.yaml builds from FriendlyELEC vendor source, uses nanopi6_defconfig, outputs idbloader.img + uboot.img format.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Hardware boot test Attempt #6 - Verify vendor U-Boot build boots</name>
  <what-built>
Vendor U-Boot build system integrated into Talos bldr pipeline:
- FriendlyELEC uboot-rockchip source added to Pkgfile
- New prepare-vendor stage for vendor source
- Updated nanopi-m6 pkg.yaml to build vendor format (idbloader.img + uboot.img)
  </what-built>
  <how-to-verify>
**Step 1: Build vendor U-Boot**
```bash
cd /Users/johnsonhuynh/Documents/GitHub/nanopi-m6
make artifacts/u-boot/nanopi-m6
```

**Step 2: Verify output files exist**
```bash
ls -la _out/artifacts/arm64/u-boot/nanopi-m6/
# Expected: idbloader.img (~200-500KB), uboot.img (~1-2MB)
```

**Step 3: Flash to SD card**
```bash
# Identify SD card
diskutil list

# Unmount
diskutil unmountDisk /dev/diskN

# Flash idbloader.img at sector 64 (32KB offset)
sudo dd if=_out/artifacts/arm64/u-boot/nanopi-m6/idbloader.img of=/dev/rdiskN bs=512 seek=64 status=progress

# Flash uboot.img at sector 16384 (8MB offset)
sudo dd if=_out/artifacts/arm64/u-boot/nanopi-m6/uboot.img of=/dev/rdiskN bs=512 seek=16384 status=progress

sync
diskutil eject /dev/diskN
```

**Step 4: Boot test**
1. Insert SD card into NanoPi M6
2. Connect HDMI monitor
3. Power on board
4. Observe for 2 minutes:
   - **SUCCESS indicators:** LED activity in 0-10s window, HDMI output
   - **FAILURE indicators:** No LED activity, board stays dark

**Step 5: Document result in BOOT-TEST-CHECKLIST.md**
Add Attempt #6 entry with result.

**Expected outcome:** LED activity observed (matching Attempt #5 success with FriendlyELEC binary).
  </how-to-verify>
  <resume-signal>Type "boot success" if LED activity observed, or describe failure symptoms</resume-signal>
</task>

</tasks>

<verification>
**Phase 2 Goal:** NanoPi M6 boots to U-Boot (verified via LED activity)

1. Build produces vendor-format bootloader:
   - `_out/artifacts/arm64/u-boot/nanopi-m6/idbloader.img` exists
   - `_out/artifacts/arm64/u-boot/nanopi-m6/uboot.img` exists

2. Hardware boot test:
   - Attempt #6 shows LED activity (replicates Attempt #5)
   - Boot activity observable within 10 seconds of power-on

3. Build system integration:
   - `make artifacts/u-boot/nanopi-m6` completes successfully
   - No manual steps required for bootloader generation
</verification>

<success_criteria>
- [ ] Pkgfile contains FriendlyELEC uboot-rockchip source reference
- [ ] prepare-vendor/pkg.yaml downloads vendor U-Boot source
- [ ] nanopi-m6/pkg.yaml builds with nanopi6_defconfig
- [ ] Build outputs idbloader.img + uboot.img (NOT u-boot-rockchip.bin)
- [ ] Boot test Attempt #6: LED activity observed (SUCCESS)
- [ ] Phase 2 goal achieved: NanoPi M6 boots to U-Boot
</success_criteria>

<output>
After completion, create `.planning/phases/02-bootloader/02-09-SUMMARY.md`

If boot test succeeds:
- Update docs/BOOT-TEST-CHECKLIST.md with Attempt #6 SUCCESS
- Update .planning/STATE.md to mark Phase 2 goal achieved
- Phase 2 is COMPLETE - ready for Phase 3 (Device Tree & Kernel)

If boot test fails:
- Document failure in BOOT-TEST-CHECKLIST.md
- Analyze differences between our build and extracted FriendlyELEC binary
- May need to extract and compare binary headers/formats
</output>
