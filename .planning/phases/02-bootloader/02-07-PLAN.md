---
phase: 02-bootloader
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - Pkgfile
  - artifacts/u-boot/nanopi-m6/pkg.yaml
  - docs/BOOT-TEST-CHECKLIST.md
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "DDR memory initializes (LPDDR5 blob loads correctly)"
    - "Boot activity observable (LED blink or eventual kernel HDMI output)"
    - "rkbin blobs match Armbian's working versions (DDR v1.18, BL31 v1.48)"
  artifacts:
    - path: "Pkgfile"
      provides: "Updated rkbin commit reference"
      contains: "0f8ac860f0479da56a1decae207ddc99e289f2e2"
    - path: "artifacts/u-boot/nanopi-m6/pkg.yaml"
      provides: "Updated blob version references"
      contains: "v1.18"
    - path: "docs/BOOT-TEST-CHECKLIST.md"
      provides: "Attempt #4 results"
      contains: "Attempt #4"
  key_links:
    - from: "Pkgfile"
      to: "artifacts/rkbin/pkg.yaml"
      via: "rkbin_ref variable"
      pattern: "rkbin_ref.*0f8ac860"
    - from: "artifacts/u-boot/nanopi-m6/pkg.yaml"
      to: "/libs/rkbin/bin/rk35/"
      via: "ROCKCHIP_TPL and BL31 env vars"
      pattern: "v1\\.18\\.bin|v1\\.48\\.elf"
---

<objective>
[GAP CLOSURE] Update rkbin blob versions to match Armbian's working configuration

Purpose: Close the DDR initialization gap that has caused all 3 boot attempts to fail. The common factor across all failures is DDR v1.16 and BL31 v1.45 - Armbian uses DDR v1.18 and BL31 v1.48.

Output: Updated build configuration with newer blobs, boot test attempt #4 results
</objective>

<execution_context>
@/Users/johnsonhuynh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johnsonhuynh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-bootloader/02-06-SUMMARY.md
@docs/ARMBIAN-UBOOT-ANALYSIS.md
@docs/BOOT-TEST-CHECKLIST.md
</context>

<gap_context>
## Gaps Being Closed

From VERIFICATION.md:

1. **DDR memory initializes (LPDDR5 blob loads correctly)** - FAILED
   - All 3 boot attempts fail at DDR training stage
   - Common factor: DDR v1.16, BL31 v1.45
   - Armbian uses: DDR v1.18, BL31 v1.48
   - Missing: Updated blob versions

2. **Boot activity observable (LED blink or eventual kernel HDMI output)** - FAILED
   - No LED, no HDMI, no network across 3 attempts
   - Missing: Working rkbin blobs

## Root Cause Analysis

| Attempt | Defconfig | U-Boot Version | DDR | BL31 | Result |
|---------|-----------|----------------|-----|------|--------|
| 1 | nanopi-r6c-rk3588s | Collabora v2023.07 | v1.16 | v1.45 | FAIL |
| 2 | rock5a + M6 DTS | Collabora v2023.07 | v1.16 | v1.45 | FAIL |
| 3 | nanopi-m6-rk3588s | Mainline v2025.10 | v1.16 | v1.45 | FAIL |

**Common factor eliminated:** U-Boot source/version, defconfig, device tree
**Common factor remaining:** DDR v1.16, BL31 v1.45

## Armbian Reference

From `rockchip64_common.inc`:
```bash
DDR_BLOB="rk35/rk3588_ddr_lp4_2112MHz_lp5_2400MHz_v1.18.bin"
BL31_BLOB="rk35/rk3588_bl31_v1.48.elf"
```

Commit with both blobs: `0f8ac860f0479da56a1decae207ddc99e289f2e2`
</gap_context>

<tasks>

<task type="auto">
  <name>Task 1: Update rkbin commit reference</name>
  <files>Pkgfile</files>
  <action>
Update Pkgfile to use rkbin commit `0f8ac860f0479da56a1decae207ddc99e289f2e2` which contains:
- DDR blob v1.18: `rk3588_ddr_lp4_2112MHz_lp5_2400MHz_v1.18.bin`
- BL31 blob v1.48: `rk3588_bl31_v1.48.elf`

Changes to make:
1. Update `rkbin_ref` from `a2a0b89b6c8c612dca5ed9ed8a68db8a07f68bc0` to `0f8ac860f0479da56a1decae207ddc99e289f2e2`
2. Update `rkbin_sha256` to `c0e3ec5c6af86ebb317c4eeb393a95b6c87519707b6a34a164ee451bb27c98ff`
3. Update `rkbin_sha512` to `4287fb19042e9b090e8eb51287eef289224c6ae95f6bc3e9040eaa4d783a28e377685e4d32a984b8a49ab5bd95b885248e910a644d088d679b4cdd94cd735de9`
4. Add comment noting this matches Armbian's blob versions

Do NOT change any other variables in Pkgfile (uboot_version, linux versions stay the same).
  </action>
  <verify>
```bash
grep -E "rkbin_ref|rkbin_sha256" Pkgfile
```
Should show new commit hash and checksum.
  </verify>
  <done>Pkgfile contains rkbin commit 0f8ac860f... with correct checksums</done>
</task>

<task type="auto">
  <name>Task 2: Update blob version references in pkg.yaml</name>
  <files>artifacts/u-boot/nanopi-m6/pkg.yaml</files>
  <action>
Update the ROCKCHIP_TPL and BL31 environment variables in `artifacts/u-boot/nanopi-m6/pkg.yaml`:

1. Change ROCKCHIP_TPL from:
   `/libs/rkbin/bin/rk35/rk3588_ddr_lp4_2112MHz_lp5_2400MHz_v1.16.bin`
   to:
   `/libs/rkbin/bin/rk35/rk3588_ddr_lp4_2112MHz_lp5_2400MHz_v1.18.bin`

2. Change BL31 from:
   `/libs/rkbin/bin/rk35/rk3588_bl31_v1.45.elf`
   to:
   `/libs/rkbin/bin/rk35/rk3588_bl31_v1.48.elf`

3. Update the debug logging comment to note this is Attempt #4 with updated blobs

Do NOT change the defconfig, device tree download, or build commands - only the blob paths.
  </action>
  <verify>
```bash
grep -E "v1\.(16|18|45|48)" artifacts/u-boot/nanopi-m6/pkg.yaml
```
Should show only v1.18 for DDR and v1.48 for BL31.
  </verify>
  <done>pkg.yaml references DDR v1.18 and BL31 v1.48 blobs</done>
</task>

<task type="auto">
  <name>Task 3: Build U-Boot with updated blobs</name>
  <files>_out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin</files>
  <action>
Build U-Boot with the updated rkbin blobs:

```bash
make local-talos-sbc-rk3588-mainline DEST=_out
```

This will:
1. Download the new rkbin commit with v1.18/v1.48 blobs
2. Build U-Boot with the updated DDR and BL31 binaries
3. Produce u-boot-rockchip.bin at _out/artifacts/arm64/u-boot/nanopi-m6/

Verify the build completes successfully and the binary is produced.
  </action>
  <verify>
```bash
ls -la _out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin
file _out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin
```
Binary should exist and be recognized as data/ARM binary.
  </verify>
  <done>u-boot-rockchip.bin built with DDR v1.18 and BL31 v1.48</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Hardware boot verification (Attempt #4)</name>
  <what-built>
U-Boot binary with updated rkbin blobs:
- DDR: v1.16 -> v1.18 (matches Armbian)
- BL31: v1.45 -> v1.48 (matches Armbian)

This directly addresses the primary suspect from root cause analysis - blob version mismatch was the only common factor across all 3 failed boot attempts.
  </what-built>
  <how-to-verify>
1. Flash U-Boot to SD card:
   ```bash
   ./hack/flash.sh --bootloader _out/artifacts/arm64/u-boot/nanopi-m6/u-boot-rockchip.bin /dev/diskN
   ```
   (Replace /dev/diskN with your SD card device)

2. Insert SD card into NanoPi M6

3. Connect HDMI monitor and power cable

4. Power on and observe for 2 minutes:

   **0-10 seconds (DDR training):**
   - Watch for LED activity (GPIO1_A4 = SYS, GPIO1_A6 = USER)
   - LED blink = DDR initialized successfully
   - No LED = DDR training failed (same as before)

   **10-30 seconds (U-Boot):**
   - Watch for HDMI signal
   - Any output = U-Boot running

   **30-120 seconds (Boot attempt):**
   - Watch for network activity (DHCP)
   - Check router for new device

5. Report results:
   - Did LEDs blink? (Y/N)
   - Did HDMI show anything? (Y/N)
   - Did device get DHCP lease? (Y/N)
   - Any other observations?
  </how-to-verify>
  <resume-signal>
Report boot test results, then type one of:
- "boot success" - LEDs blinked, some boot activity observed
- "boot failed" - Same as before, no LED activity
- "partial" - Some improvement but not full boot
  </resume-signal>
</task>

</tasks>

<verification>
## Phase Goal Check

After Task 4, verify against Phase 2 success criteria:

| Criteria | Expected After This Plan |
|----------|--------------------------|
| U-Boot binary compiles with NanoPi M6-specific defconfig | Already achieved (02-06) |
| DDR memory initializes (LPDDR5 blob loads correctly) | **Testing with v1.18** |
| Boot activity observable (LED blink or eventual kernel HDMI output) | **Testing** |
| Recovery procedure documented and tested (MaskROM mode) | Already achieved (02-02) |

## Blob Version Comparison

| Component | Previous (02-06) | This Plan (02-07) | Armbian |
|-----------|------------------|-------------------|---------|
| DDR blob | v1.16 | v1.18 | v1.18 |
| BL31 | v1.45 | v1.48 | v1.48 |
| U-Boot | v2025.10 | v2025.10 | v2025.10 |
| Defconfig | nanopi-m6-rk3588s | nanopi-m6-rk3588s | nanopi-m6-rk3588s |

After this plan, our build configuration matches Armbian exactly.
</verification>

<success_criteria>
1. Pkgfile updated with new rkbin commit reference
2. pkg.yaml updated with v1.18/v1.48 blob paths
3. U-Boot builds successfully with updated blobs
4. Boot test Attempt #4 conducted with results documented

**If boot succeeds:** Phase 2 complete, proceed to Phase 3
**If boot fails:** New hypothesis needed (SD card boot path or hardware-specific issue)
</success_criteria>

<output>
After completion, create `.planning/phases/02-bootloader/02-07-SUMMARY.md`

Update `docs/BOOT-TEST-CHECKLIST.md` with Attempt #4 results.

If boot fails, update `.planning/STATE.md` with new blockers/recommendations.
</output>
