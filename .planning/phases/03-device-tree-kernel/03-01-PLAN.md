---
phase: 03-device-tree-kernel
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - artifacts/kernel/mainline/prepare/pkg.yaml
autonomous: true

must_haves:
  truths:
    - "NanoPi M6 device tree compiles without errors during kernel build"
    - "DTB file rk3588s-nanopi-m6.dtb exists in build output"
  artifacts:
    - path: "artifacts/kernel/mainline/prepare/pkg.yaml"
      provides: "DTS download and Makefile integration"
      contains: "rk3588s-nanopi-m6"
  key_links:
    - from: "artifacts/kernel/mainline/prepare/pkg.yaml"
      to: "arch/arm64/boot/dts/rockchip/Makefile"
      via: "sed command adding dtb entry"
      pattern: "rk3588s-nanopi-m6.dtb"
---

<objective>
Add NanoPi M6 device tree source to the kernel build pipeline

Purpose: The kernel build must produce rk3588s-nanopi-m6.dtb for the installer to copy to the boot partition. Without this DTB, the kernel cannot properly initialize hardware on NanoPi M6.

Output: Modified kernel prepare stage that downloads NanoPi M6 DTS from Armbian and adds it to the Rockchip Makefile for compilation.
</objective>

<execution_context>
@/Users/johnsonhuynh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johnsonhuynh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-device-tree-kernel/03-CONTEXT.md
@.planning/phases/03-device-tree-kernel/03-RESEARCH.md

# Key existing files
@artifacts/kernel/mainline/prepare/pkg.yaml
@artifacts/kernel/mainline/build/pkg.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add NanoPi M6 DTS download to kernel prepare stage</name>
  <files>artifacts/kernel/mainline/prepare/pkg.yaml</files>
  <action>
Modify the kernel prepare pkg.yaml to download the NanoPi M6 device tree and integrate it into the kernel build:

1. After the `tar -xjf` extraction step, add commands to:
   - Download rk3588s-nanopi-m6.dts from Armbian build repo:
     URL: https://raw.githubusercontent.com/armbian/build/main/patch/u-boot/v2025.10/dt_upstream_rockchip/rk3588s-nanopi-m6.dts
     Destination: arch/arm64/boot/dts/rockchip/rk3588s-nanopi-m6.dts

   - Add the DTB entry to the Rockchip Makefile using sed:
     Pattern: Find existing rk3588s-*.dtb entries (like rk3588s-nanopi-r6s.dtb)
     Add: dtb-$(CONFIG_ARCH_ROCKCHIP) += rk3588s-nanopi-m6.dtb

2. Use curl with -fsSL flags for silent, fail-on-error download
3. Place the download AFTER tar extraction but BEFORE make mrproper
4. The sed command should be idempotent (safe to run multiple times)

IMPORTANT: The existing pkg.yaml structure uses multi-line bash scripts in prepare blocks. Maintain this pattern.
  </action>
  <verify>
Read the modified pkg.yaml and confirm:
1. curl command downloads DTS to correct path
2. sed command adds Makefile entry
3. Commands are placed after tar extraction
  </verify>
  <done>
pkg.yaml contains DTS download and Makefile integration commands that will execute during kernel prepare stage
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify DTS compilation with local build test</name>
  <files>None (build verification only)</files>
  <action>
Run a partial kernel build to verify DTS compilation works:

1. Use the existing Makefile target to build just the kernel prepare and build stages:
   ```
   make local-talos-kernel-rk3588-mainline PLATFORM=linux/arm64 DEST=_out
   ```

   Note: If full build takes too long, check if there's a way to build just DTBs.
   The build system uses bldr which may not support partial targets.

2. If build succeeds, verify the DTB exists in output:
   ```
   find _out -name "rk3588s-nanopi-m6.dtb"
   ```

3. If build fails, check error output for:
   - Missing includes (may need to verify DTS compatibility with Collabora kernel)
   - Syntax errors in DTS
   - Missing Makefile entry

FALLBACK: If full build is too slow for this task, verify the pkg.yaml changes are syntactically correct and commit. The full integration test will happen in Plan 03.
  </action>
  <verify>
Either:
- DTB file exists in _out directory, OR
- pkg.yaml changes are committed and build test deferred to Plan 03
  </verify>
  <done>
DTS integration verified through build test or syntax verification
  </done>
</task>

</tasks>

<verification>
- pkg.yaml modification is syntactically valid YAML
- DTS download URL is correct and accessible
- Makefile sed pattern matches Rockchip Makefile format
- Changes follow existing codebase patterns (multi-line bash in prepare blocks)
</verification>

<success_criteria>
1. artifacts/kernel/mainline/prepare/pkg.yaml contains NanoPi M6 DTS download
2. Makefile entry will be added during build
3. Either local build produces DTB or changes are ready for integration test
</success_criteria>

<output>
After completion, create `.planning/phases/03-device-tree-kernel/03-01-SUMMARY.md`
</output>
