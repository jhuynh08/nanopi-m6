---
phase: 03-device-tree-kernel
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - artifacts/kernel/mainline/prepare/pkg.yaml
autonomous: true

must_haves:
  truths:
    - "NanoPi M6 device tree compiles without errors during kernel build"
    - "DTB file rk3588s-nanopi-m6.dtb exists in build output"
  artifacts:
    - path: "artifacts/kernel/mainline/prepare/pkg.yaml"
      provides: "DTS download and Makefile integration"
      contains: "rk3588s-nanopi-m6"
  key_links:
    - from: "artifacts/kernel/mainline/prepare/pkg.yaml"
      to: "arch/arm64/boot/dts/rockchip/Makefile"
      via: "sed command adding dtb entry"
      pattern: "rk3588s-nanopi-m6.dtb"
---

<objective>
Add NanoPi M6 device tree source to the kernel build pipeline

Purpose: The kernel build must produce rk3588s-nanopi-m6.dtb for the installer to copy to the boot partition. Without this DTB, the kernel cannot properly initialize hardware on NanoPi M6.

Output: Modified kernel prepare stage that downloads NanoPi M6 DTS from Armbian and adds it to the Rockchip Makefile for compilation.
</objective>

<execution_context>
@/Users/johnsonhuynh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johnsonhuynh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-device-tree-kernel/03-CONTEXT.md
@.planning/phases/03-device-tree-kernel/03-RESEARCH.md

# Key existing files
@artifacts/kernel/mainline/prepare/pkg.yaml
@artifacts/kernel/mainline/build/pkg.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add NanoPi M6 DTS download to kernel prepare stage</name>
  <files>artifacts/kernel/mainline/prepare/pkg.yaml</files>
  <action>
Modify the kernel prepare pkg.yaml to download the NanoPi M6 device tree and integrate it into the kernel build:

**IMPORTANT CONTEXT:** The Armbian build repository hosts the FriendlyELEC-derived device tree for NanoPi M6. This DTS was contributed by @efectn who works on Armbian and sources hardware support from FriendlyELEC. Using Armbian's DTS fulfills the user decision to "Use FriendlyELEC vendor DTS as base" - Armbian is simply the hosting location for the FriendlyELEC-derived community DTS.

1. After the `tar -xjf` extraction step, add commands to:
   - Download rk3588s-nanopi-m6.dts from Armbian build repo:
     URL: https://raw.githubusercontent.com/armbian/build/main/patch/u-boot/v2025.10/dt_upstream_rockchip/rk3588s-nanopi-m6.dts
     Destination: arch/arm64/boot/dts/rockchip/rk3588s-nanopi-m6.dts

   - Add the DTB entry to the Rockchip Makefile using sed:
     Pattern: Find existing rk3588s-*.dtb entries (like rk3588s-nanopi-r6s.dtb)
     Add: dtb-$(CONFIG_ARCH_ROCKCHIP) += rk3588s-nanopi-m6.dtb

2. Use curl with -fsSL flags for silent, fail-on-error download
3. Place the download AFTER tar extraction but BEFORE make mrproper
4. The sed command should be idempotent (safe to run multiple times)

IMPORTANT: The existing pkg.yaml structure uses multi-line bash scripts in prepare blocks. Maintain this pattern.
  </action>
  <verify>
Read the modified pkg.yaml and confirm:
1. curl command downloads DTS to correct path
2. sed command adds Makefile entry
3. Commands are placed after tar extraction
  </verify>
  <done>
pkg.yaml contains DTS download and Makefile integration commands that will execute during kernel prepare stage
  </done>
</task>

<task type="auto">
  <name>Task 2: Validate pkg.yaml syntax and structure</name>
  <files>None (validation only)</files>
  <action>
Validate that the modified pkg.yaml is syntactically correct:

1. Validate YAML syntax using Python or yq:
   ```bash
   python3 -c "import yaml; yaml.safe_load(open('artifacts/kernel/mainline/prepare/pkg.yaml'))" && echo "YAML valid"
   ```
   OR
   ```bash
   yq . artifacts/kernel/mainline/prepare/pkg.yaml > /dev/null && echo "YAML valid"
   ```

2. Verify the multi-line bash script block is properly indented and uses correct YAML block scalar syntax (|)

3. Check that the curl URL is accessible:
   ```bash
   curl -fsSL -I "https://raw.githubusercontent.com/armbian/build/main/patch/u-boot/v2025.10/dt_upstream_rockchip/rk3588s-nanopi-m6.dts" | head -1
   ```
   Expected: HTTP/2 200

NOTE: Full DTB build test is deferred to Plan 03-03 which runs the complete build. This task validates the pkg.yaml changes are correct and ready for integration.
  </action>
  <verify>
1. YAML syntax validation command exits with code 0
2. curl HEAD request to DTS URL returns HTTP 200
3. pkg.yaml committed to git
  </verify>
  <done>
pkg.yaml is syntactically valid YAML, DTS URL is accessible, changes are committed and ready for full build test in Plan 03-03
  </done>
</task>

</tasks>

<verification>
- pkg.yaml modification is syntactically valid YAML
- DTS download URL is correct and accessible
- Makefile sed pattern matches Rockchip Makefile format
- Changes follow existing codebase patterns (multi-line bash in prepare blocks)
</verification>

<success_criteria>
1. artifacts/kernel/mainline/prepare/pkg.yaml contains NanoPi M6 DTS download
2. Makefile entry will be added during build
3. YAML syntax validated, DTS URL accessible
4. Changes committed and ready for integration test in Plan 03-03
</success_criteria>

<output>
After completion, create `.planning/phases/03-device-tree-kernel/03-01-SUMMARY.md`
</output>
