---
phase: 03-device-tree-kernel
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - artifacts/dtb/rockchip/rk3588s-nanopi-m6.dtb
  - artifacts/dtb/pkg.yaml
autonomous: true

must_haves:
  truths:
    - "Pre-extracted FriendlyELEC DTB is committed to repository"
    - "DTB pkg.yaml copies DTB to correct output location during build"
  artifacts:
    - path: "artifacts/dtb/rockchip/rk3588s-nanopi-m6.dtb"
      provides: "Pre-extracted vendor DTB from FriendlyELEC image"
    - path: "artifacts/dtb/pkg.yaml"
      provides: "Build stage to copy DTB to output"
  key_links:
    - from: "artifacts/dtb/rockchip/rk3588s-nanopi-m6.dtb"
      to: "_out/arm64/dtb/rockchip/rk3588s-nanopi-m6.dtb"
      via: "pkg.yaml copy during build"
---

<objective>
Commit pre-extracted FriendlyELEC DTB and configure build to use it

Purpose: Use the known-working DTB extracted from FriendlyELEC's Ubuntu image (same source as vendor U-Boot). This mirrors the Phase 2 approach - use vendor binaries instead of compiling from source.

Output: Committed DTB binary and build configuration to include it in the image.
</objective>

<execution_context>
@/Users/johnsonhuynh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johnsonhuynh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-device-tree-kernel/03-CONTEXT.md

# Pre-extracted DTB (already exists from extraction)
@artifacts/dtb/rockchip/rk3588s-nanopi-m6.dtb
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify pre-extracted DTB and commit to repository</name>
  <files>artifacts/dtb/rockchip/rk3588s-nanopi-m6.dtb</files>
  <action>
The DTB was extracted from FriendlyELEC's rk3588-sd-ubuntu-noble-minimal-6.1-arm64-20251222.img.

1. Verify the DTB is valid:
   ```bash
   file artifacts/dtb/rockchip/rk3588s-nanopi-m6.dtb
   # Expected: Device Tree Blob version 17, size=...

   strings artifacts/dtb/rockchip/rk3588s-nanopi-m6.dtb | grep -i "nanopi"
   # Expected: friendlyelec,nanopi-m6
   ```

2. Commit the DTB to the repository:
   ```bash
   git add artifacts/dtb/rockchip/rk3588s-nanopi-m6.dtb
   git commit -m "feat(dtb): add pre-extracted FriendlyELEC NanoPi M6 DTB

   Extracted from FriendlyELEC Ubuntu image (rk3588-sd-ubuntu-noble-minimal-6.1-arm64-20251222.img).

   This is the same approach used for vendor U-Boot in Phase 2 - use known-working
   vendor binaries instead of compiling from source.

   Source: FriendlyELEC resource partition, DTB #24 (NanoPi M6)
   Model: FriendlyElec NanoPi M6
   Compatible: friendlyelec,nanopi-m6, rockchip,rk3588"
   ```
  </action>
  <verify>
1. DTB file is ~262KB
2. `file` command shows Device Tree Blob
3. DTB is committed to git
  </verify>
  <done>
Pre-extracted FriendlyELEC DTB committed to repository
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DTB pkg.yaml to copy DTB during build</name>
  <files>artifacts/dtb/pkg.yaml</files>
  <action>
Create a pkg.yaml that copies the pre-extracted DTB to the correct output location during build.

Create artifacts/dtb/pkg.yaml:
```yaml
# Pre-extracted device tree blobs for boards requiring vendor DTBs
#
# NanoPi M6 uses a vendor DTB extracted from FriendlyELEC's Ubuntu image.
# This mirrors the vendor U-Boot approach from Phase 2.
#
# Source: rk3588-sd-ubuntu-noble-minimal-6.1-arm64-20251222.img
name: dtb-vendor
variant: scratch
shell: /toolchain/bin/bash
dependencies:
  - stage: base
steps:
  - install:
      - |
        mkdir -p /rootfs/dtb/rockchip

        # Copy NanoPi M6 vendor DTB
        cp -v /src/artifacts/dtb/rockchip/rk3588s-nanopi-m6.dtb /rootfs/dtb/rockchip/

        echo "Installed vendor DTBs:"
        ls -la /rootfs/dtb/rockchip/
finalize:
  - from: /rootfs
    to: /rootfs
```

Note: Check how existing DTBs are handled in the build (artifacts/kernel/mainline/kernel/pkg.yaml installs to /rootfs/dtb). The vendor DTB may need to go to the same location or be merged.
  </action>
  <verify>
1. pkg.yaml exists at artifacts/dtb/pkg.yaml
2. YAML syntax is valid: `python3 -c "import yaml; yaml.safe_load(open('artifacts/dtb/pkg.yaml'))"`
3. Path /rootfs/dtb/rockchip/ matches kernel build output structure
  </verify>
  <done>
DTB pkg.yaml created to copy vendor DTB during build
  </done>
</task>

<task type="auto">
  <name>Task 3: Add DTB stage to Pkgfile</name>
  <files>Pkgfile</files>
  <action>
Add the dtb-vendor stage to the Pkgfile so it's included in the build.

1. Check how existing artifact stages are included:
   ```bash
   grep -n "dtb\|kernel\|u-boot" Pkgfile | head -20
   ```

2. Add dtb-vendor target if not already present:
   - Should depend on base stage
   - Should be included in the final image targets

3. Verify the stage will be built:
   ```bash
   grep "dtb-vendor" Pkgfile
   ```

IMPORTANT: The exact integration depends on how the Pkgfile is structured. May need to add to a TARGETS variable or similar.
  </action>
  <verify>
1. dtb-vendor stage referenced in Pkgfile
2. Stage will be built as part of the image
  </verify>
  <done>
DTB vendor stage added to build system
  </done>
</task>

</tasks>

<verification>
- Pre-extracted DTB is committed (262KB, valid FDT format)
- pkg.yaml copies DTB to /rootfs/dtb/rockchip/
- Pkgfile includes dtb-vendor stage
- Build system will include vendor DTB in final image
</verification>

<success_criteria>
1. artifacts/dtb/rockchip/rk3588s-nanopi-m6.dtb committed
2. artifacts/dtb/pkg.yaml created and valid
3. DTB stage integrated into build
4. Ready for full build test in Plan 03-03
</success_criteria>

<output>
After completion, create `.planning/phases/03-device-tree-kernel/03-01-SUMMARY.md`
</output>
