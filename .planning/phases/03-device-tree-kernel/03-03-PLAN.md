---
phase: 03-device-tree-kernel
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - artifacts/u-boot/nanopi-m6-vendor/idbloader.img
  - artifacts/u-boot/nanopi-m6-vendor/uboot.img
  - artifacts/u-boot/nanopi-m6/pkg.yaml
autonomous: true

must_haves:
  truths:
    - "Full Talos SBC image builds successfully for NanoPi M6"
    - "Build output contains pre-extracted vendor DTB"
    - "Build output contains vendor U-Boot binaries (idbloader.img, uboot.img)"
    - "Flashable image can be written to SD card"
  artifacts:
    - path: "_out/arm64/dtb/rockchip/rk3588s-nanopi-m6.dtb"
      provides: "Pre-extracted FriendlyELEC DTB"
    - path: "_out/arm64/u-boot/nanopi-m6/idbloader.img"
      provides: "Vendor bootloader stage 1"
    - path: "_out/arm64/u-boot/nanopi-m6/uboot.img"
      provides: "Vendor bootloader stage 2"
  key_links:
    - from: "Makefile"
      to: "_out/"
      via: "make local-talos-sbc-rk3588-mainline"
---

<objective>
Build complete Talos SBC image for NanoPi M6 with pre-extracted vendor DTB and U-Boot

Purpose: Produce a flashable image using all pre-extracted FriendlyELEC binaries (DTB from Plan 01, U-Boot from Phase 2). This mirrors the vendor approach - known-working binaries rather than compiling from source.

Output: Compressed raw disk image ready to flash to SD card for hardware testing.
</objective>

<execution_context>
@/Users/johnsonhuynh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johnsonhuynh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-device-tree-kernel/03-CONTEXT.md

# Dependencies from this phase
@.planning/phases/03-device-tree-kernel/03-01-SUMMARY.md
@.planning/phases/03-device-tree-kernel/03-02-SUMMARY.md

# Key files
@Makefile
@artifacts/u-boot/nanopi-m6/pkg.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Commit vendor U-Boot binaries and update pkg.yaml</name>
  <files>artifacts/u-boot/nanopi-m6-vendor/, artifacts/u-boot/nanopi-m6/pkg.yaml</files>
  <action>
The vendor U-Boot binaries were extracted in Phase 2 and exist in _out/. Commit them to the repo and update pkg.yaml to use them.

**KNOWN STATE:**
- Vendor binaries exist at: `_out/artifacts/arm64/u-boot/nanopi-m6/idbloader.img` and `uboot.img`
- These are extracted from FriendlyELEC's Ubuntu image (same source as vendor DTB)
- Current pkg.yaml builds mainline U-Boot which does NOT boot

1. Commit vendor binaries:
   ```bash
   mkdir -p artifacts/u-boot/nanopi-m6-vendor
   cp _out/artifacts/arm64/u-boot/nanopi-m6/idbloader.img artifacts/u-boot/nanopi-m6-vendor/
   cp _out/artifacts/arm64/u-boot/nanopi-m6/uboot.img artifacts/u-boot/nanopi-m6-vendor/

   git add artifacts/u-boot/nanopi-m6-vendor/
   git commit -m "feat(u-boot): add pre-extracted FriendlyELEC vendor U-Boot binaries

   Extracted from FriendlyELEC Ubuntu image (rk3588-sd-ubuntu-noble-minimal-6.1-arm64-20251222.img).

   Files:
   - idbloader.img: Rockchip bootloader stage 1 (sector 64)
   - uboot.img: U-Boot proper (sector 16384)

   These binaries were validated in Phase 2 boot test Attempt #5 and #6."
   ```

2. Update artifacts/u-boot/nanopi-m6/pkg.yaml to copy vendor binaries instead of building:
   ```yaml
   # FriendlyELEC vendor U-Boot for NanoPi M6
   #
   # Uses pre-extracted binaries from FriendlyELEC Ubuntu image.
   # Mainline U-Boot does NOT boot on NanoPi M6 (validated in Phase 2).
   #
   # Source: rk3588-sd-ubuntu-noble-minimal-6.1-arm64-20251222.img
   name: u-boot-nanopi-m6
   variant: scratch
   shell: /toolchain/bin/bash
   dependencies:
     - stage: base
   steps:
     - install:
         - |
           mkdir -p /rootfs/artifacts/arm64/u-boot/nanopi-m6

           # Copy pre-extracted vendor binaries
           cp -v /src/artifacts/u-boot/nanopi-m6-vendor/idbloader.img /rootfs/artifacts/arm64/u-boot/nanopi-m6/
           cp -v /src/artifacts/u-boot/nanopi-m6-vendor/uboot.img /rootfs/artifacts/arm64/u-boot/nanopi-m6/

           echo "Installed vendor U-Boot:"
           ls -la /rootfs/artifacts/arm64/u-boot/nanopi-m6/
   finalize:
     - from: /rootfs
       to: /rootfs
   ```
  </action>
  <verify>
1. Vendor binaries committed at artifacts/u-boot/nanopi-m6-vendor/
2. pkg.yaml updated to copy (not build) vendor binaries
3. YAML syntax is valid
  </verify>
  <done>
Vendor U-Boot binaries committed and pkg.yaml updated to use them
  </done>
</task>

<task type="auto">
  <name>Task 2: Build full Talos SBC image for NanoPi M6</name>
  <files>None (build verification)</files>
  <action>
Run the full build to produce the NanoPi M6 image:

```bash
cd /Users/johnsonhuynh/Documents/GitHub/nanopi-m6
make local-talos-sbc-rk3588-mainline PLATFORM=linux/arm64 DEST=_out
```

This build may take 30-60 minutes. Monitor for:
1. DTB copy errors (from Plan 01 vendor DTB)
2. U-Boot copy errors (from Task 1 vendor binaries)
3. Installer build errors (from Plan 02 changes)

If build succeeds, verify outputs:
```bash
# Check vendor DTB exists
ls -la _out/arm64/dtb/rockchip/rk3588s-nanopi-m6.dtb

# Check vendor U-Boot binaries
ls -la _out/arm64/u-boot/nanopi-m6/

# Check final image
ls -la _out/*.raw.xz
```

If build fails:
1. Save error log
2. Identify failing stage
3. Fix and retry
  </action>
  <verify>
All expected artifacts exist:
- _out/arm64/dtb/rockchip/rk3588s-nanopi-m6.dtb (vendor DTB)
- _out/arm64/u-boot/nanopi-m6/idbloader.img (vendor U-Boot)
- _out/arm64/u-boot/nanopi-m6/uboot.img (vendor U-Boot)
- _out/talos-sbc-rk3588-arm64*.raw.xz (final image)
  </verify>
  <done>
Full Talos SBC build completes with NanoPi M6 vendor artifacts
  </done>
</task>

<task type="auto">
  <name>Task 3: Flash image to SD card for hardware test</name>
  <files>None (hardware preparation)</files>
  <action>
Prepare SD card with the built image:

1. Decompress the image:
```bash
xz -dk _out/talos-sbc-rk3588-arm64-*.raw.xz
```

2. Identify SD card device (CAREFUL - verify correct device!):
```bash
diskutil list
```
Look for the SD card (typically /dev/disk4 or similar, ~32GB or whatever size)

3. Unmount and flash:
```bash
diskutil unmountDisk /dev/diskN
sudo dd if=_out/talos-sbc-rk3588-arm64-*.raw of=/dev/rdiskN bs=1m status=progress
```

4. Eject:
```bash
diskutil eject /dev/diskN
```

Note: Use rdisk (raw disk) for faster writes on macOS.

IMPORTANT: Double-check disk number before dd to avoid data loss!
  </action>
  <verify>
1. SD card is written without errors
2. Card can be safely ejected
3. Ready for hardware boot test in Plan 04
  </verify>
  <done>
SD card prepared with NanoPi M6 Talos image ready for hardware testing
  </done>
</task>

</tasks>

<verification>
- Vendor U-Boot binaries committed and pkg.yaml updated
- Vendor DTB included in build (from Plan 01)
- Full build completes without errors
- Image can be written to SD card
- All vendor artifacts from same FriendlyELEC image source
</verification>

<success_criteria>
1. Build includes vendor DTB (rk3588s-nanopi-m6.dtb)
2. Build includes vendor U-Boot (idbloader.img + uboot.img)
3. Compressed image exists in _out/
4. SD card is flashed and ready for hardware test
</success_criteria>

<output>
After completion, create `.planning/phases/03-device-tree-kernel/03-03-SUMMARY.md`
</output>
