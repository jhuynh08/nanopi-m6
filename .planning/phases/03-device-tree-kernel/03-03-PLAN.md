---
phase: 03-device-tree-kernel
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - artifacts/u-boot/nanopi-m6/pkg.yaml
autonomous: true

must_haves:
  truths:
    - "Full Talos SBC image builds successfully for NanoPi M6"
    - "Build output contains rk3588s-nanopi-m6.dtb"
    - "Build output contains vendor U-Boot binaries (idbloader.img, uboot.img)"
    - "Flashable image can be written to SD card"
  artifacts:
    - path: "_out/talos-sbc-rk3588-arm64-nanopi-m6.raw.xz"
      provides: "Bootable NanoPi M6 image"
    - path: "_out/arm64/dtb/rockchip/rk3588s-nanopi-m6.dtb"
      provides: "NanoPi M6 device tree blob"
    - path: "_out/arm64/u-boot/nanopi-m6/idbloader.img"
      provides: "Vendor bootloader stage 1"
    - path: "_out/arm64/u-boot/nanopi-m6/uboot.img"
      provides: "Vendor bootloader stage 2"
  key_links:
    - from: "Makefile"
      to: "_out/"
      via: "make local-talos-sbc-rk3588-mainline"
      pattern: "DEST=_out"
---

<objective>
Build complete Talos SBC image for NanoPi M6 with kernel, DTB, and vendor U-Boot

Purpose: Produce a flashable image that combines all Phase 3 work (DTS, installer) with the vendor U-Boot from Phase 2. This image will be used for hardware driver validation.

Output: Compressed raw disk image ready to flash to SD card for hardware testing.
</objective>

<execution_context>
@/Users/johnsonhuynh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johnsonhuynh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-device-tree-kernel/03-CONTEXT.md
@.planning/phases/03-device-tree-kernel/03-RESEARCH.md

# Dependencies from this phase
@.planning/phases/03-device-tree-kernel/03-01-SUMMARY.md
@.planning/phases/03-device-tree-kernel/03-02-SUMMARY.md

# Key files
@Makefile
@artifacts/u-boot/nanopi-m6/pkg.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update U-Boot pkg.yaml to output vendor binaries</name>
  <files>artifacts/u-boot/nanopi-m6/pkg.yaml</files>
  <action>
The current nanopi-m6 pkg.yaml builds mainline U-Boot (which doesn't work) and outputs u-boot-rockchip.bin. We need to update it to copy the pre-extracted vendor binaries instead.

Update artifacts/u-boot/nanopi-m6/pkg.yaml:

1. Remove or comment out the mainline U-Boot build steps
2. Change to copy pre-extracted vendor binaries from artifacts/u-boot/friendlyelec-vendor/
3. Output both idbloader.img and uboot.img to the correct artifact path

The pkg.yaml should:
- Depend on prepare-vendor stage (if it provides the binaries)
- OR directly copy from the committed friendlyelec-vendor directory

Check if friendlyelec-vendor directory exists:
```bash
ls -la artifacts/u-boot/friendlyelec-vendor/
```

If binaries exist there, update pkg.yaml to:
```yaml
name: u-boot-nanopi-m6
variant: scratch
shell: /toolchain/bin/bash
dependencies:
  - stage: prepare-vendor  # or appropriate stage
steps:
  - install:
      - |
        mkdir -p /rootfs/artifacts/arm64/u-boot/nanopi-m6
        cp -v /path/to/idbloader.img /rootfs/artifacts/arm64/u-boot/nanopi-m6/
        cp -v /path/to/uboot.img /rootfs/artifacts/arm64/u-boot/nanopi-m6/
finalize:
  - from: /rootfs
    to: /rootfs
```

IMPORTANT: First check what artifacts/u-boot/prepare-vendor/pkg.yaml provides, and what path the pre-extracted binaries are at.
  </action>
  <verify>
1. Read the updated pkg.yaml
2. Verify it copies idbloader.img and uboot.img (not u-boot-rockchip.bin)
3. Verify paths match what the installer expects
  </verify>
  <done>
U-Boot pkg.yaml produces vendor binaries at correct artifact paths
  </done>
</task>

<task type="auto">
  <name>Task 2: Build full Talos SBC image for NanoPi M6</name>
  <files>None (build verification)</files>
  <action>
Run the full build to produce the NanoPi M6 image:

```bash
cd /Users/johnsonhuynh/Documents/GitHub/nanopi-m6
make local-talos-sbc-rk3588-mainline PLATFORM=linux/arm64 DEST=_out
```

This build may take 30-60 minutes. Monitor for:
1. DTS compilation errors (from Plan 01 changes)
2. U-Boot artifact copy errors (from this plan's Task 1)
3. Installer build errors (from Plan 02 changes)

If build succeeds, verify outputs:
```bash
# Check DTB exists
ls -la _out/arm64/dtb/rockchip/rk3588s-nanopi-m6.dtb

# Check U-Boot binaries
ls -la _out/arm64/u-boot/nanopi-m6/

# Check final image
ls -la _out/*.raw.xz
```

If build fails:
1. Save error log
2. Identify failing stage
3. Fix and retry
  </action>
  <verify>
All expected artifacts exist:
- _out/arm64/dtb/rockchip/rk3588s-nanopi-m6.dtb
- _out/arm64/u-boot/nanopi-m6/idbloader.img
- _out/arm64/u-boot/nanopi-m6/uboot.img
- _out/talos-sbc-rk3588-arm64*.raw.xz (or similar)
  </verify>
  <done>
Full Talos SBC build completes with NanoPi M6 artifacts
  </done>
</task>

<task type="auto">
  <name>Task 3: Flash image to SD card for hardware test</name>
  <files>None (hardware preparation)</files>
  <action>
Prepare SD card with the built image:

1. Decompress the image:
```bash
xz -dk _out/talos-sbc-rk3588-arm64-*.raw.xz
```

2. Identify SD card device (CAREFUL - verify correct device!):
```bash
diskutil list
```
Look for the SD card (typically /dev/disk4 or similar, ~32GB or whatever size)

3. Unmount and flash:
```bash
diskutil unmountDisk /dev/diskN
sudo dd if=_out/talos-sbc-rk3588-arm64-*.raw of=/dev/rdiskN bs=1m status=progress
```

4. Eject:
```bash
diskutil eject /dev/diskN
```

Note: Use rdisk (raw disk) for faster writes on macOS.

IMPORTANT: Double-check disk number before dd to avoid data loss!
  </action>
  <verify>
1. SD card is written without errors
2. Card can be safely ejected
3. Ready for hardware boot test in Plan 04
  </verify>
  <done>
SD card prepared with NanoPi M6 Talos image ready for hardware testing
  </done>
</task>

</tasks>

<verification>
- U-Boot pkg.yaml outputs vendor binaries (not mainline)
- Full build completes without errors
- DTB file exists in output
- Image can be written to SD card
- All artifact paths match what installer expects
</verification>

<success_criteria>
1. Build produces rk3588s-nanopi-m6.dtb
2. Build produces idbloader.img and uboot.img for nanopi-m6
3. Compressed image exists in _out/
4. SD card is flashed and ready for hardware test
</success_criteria>

<output>
After completion, create `.planning/phases/03-device-tree-kernel/03-03-SUMMARY.md`
</output>
