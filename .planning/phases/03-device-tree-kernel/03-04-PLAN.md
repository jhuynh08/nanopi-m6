---
phase: 03-device-tree-kernel
plan: 04
type: execute
wave: 3
depends_on: ["03-03"]
files_modified:
  - docs/BOOT-TEST-CHECKLIST.md
autonomous: false

must_haves:
  truths:
    - "Linux kernel boots to console (dmesg visible via HDMI)"
    - "Device tree correctly identifies board as NanoPi M6"
    - "Gigabit Ethernet interface appears (eth0 visible)"
    - "USB host ports enumerate connected devices"
    - "NVMe drive detected (critical for root filesystem)"
  artifacts:
    - path: "docs/BOOT-TEST-CHECKLIST.md"
      provides: "Phase 3 hardware validation results"
      contains: "Phase 3 Attempt"
  key_links:
    - from: "kernel"
      to: "rk3588s-nanopi-m6.dtb"
      via: "device tree loading"
      pattern: "FriendlyElec NanoPi M6"
    - from: "kernel"
      to: "stmmac driver"
      via: "GMAC Ethernet"
      pattern: "eth0.*BROADCAST"
    - from: "kernel"
      to: "nvme driver"
      via: "PCIe NVMe"
      pattern: "nvme0n1"
---

<objective>
Validate essential hardware drivers boot correctly on NanoPi M6

Purpose: Confirm the kernel and device tree properly initialize critical hardware: Ethernet (for Talos cluster), USB (for peripherals), and NVMe (for root filesystem since this device has no eMMC).

Output: Documented hardware validation results confirming Phase 3 success criteria.
</objective>

<execution_context>
@/Users/johnsonhuynh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johnsonhuynh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-device-tree-kernel/03-CONTEXT.md
@.planning/phases/03-device-tree-kernel/03-RESEARCH.md

# Dependencies
@.planning/phases/03-device-tree-kernel/03-03-SUMMARY.md
@docs/BOOT-TEST-CHECKLIST.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Document validation test procedure</name>
  <files>docs/BOOT-TEST-CHECKLIST.md</files>
  <action>
Add Phase 3 kernel/driver validation section to the boot test checklist:

```markdown
## Phase 3: Kernel & Driver Validation

### Pre-boot Checklist
- [ ] SD card from Plan 03-03 inserted
- [ ] HDMI monitor connected
- [ ] USB keyboard connected (optional but helpful)
- [ ] NVMe drive installed in M.2 slot
- [ ] Ethernet cable connected

### Boot Validation Steps

#### 1. Kernel Boot
Expected: Kernel boots, dmesg scrolls on HDMI
- [ ] Power on device
- [ ] Wait for boot messages on HDMI
- [ ] Kernel version visible in early dmesg

#### 2. Device Tree Identification
Command: `cat /proc/device-tree/model`
Expected: "FriendlyElec NanoPi M6"
- [ ] Board model correctly identified

#### 3. Ethernet (CRITICAL - Priority 1)
Commands:
```
ip link show
dmesg | grep -i stmmac
dmesg | grep -i eth
```
Expected:
- eth0 interface visible
- stmmac driver loaded
- Link LED on (if cable connected)
- [ ] Ethernet interface exists
- [ ] GMAC driver loaded

#### 4. USB Host (Priority 2)
Commands:
```
lsusb
dmesg | grep -i usb
dmesg | grep -i xhci
```
Expected:
- USB hub(s) visible
- Connected devices enumerate
- [ ] USB controller initialized
- [ ] Devices enumerate

#### 5. NVMe Storage (CRITICAL - Priority 3)
Commands:
```
lsblk
dmesg | grep -i nvme
dmesg | grep -i pcie
```
Expected:
- nvme0n1 device visible
- PCIe link established
- [ ] NVMe device detected
- [ ] PCIe controller working
```

This documents what to check during the hardware validation checkpoint.
  </action>
  <verify>
Read BOOT-TEST-CHECKLIST.md and confirm Phase 3 section exists with all validation steps
  </verify>
  <done>
Validation test procedure documented
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Talos kernel image with NanoPi M6 device tree, vendor U-Boot, and driver support for Ethernet, USB, and NVMe.
  </what-built>
  <how-to-verify>
Boot the NanoPi M6 with the SD card from Plan 03-03 and verify drivers:

**Setup:**
1. Insert SD card (from Plan 03-03) into NanoPi M6
2. Connect HDMI monitor
3. Connect Ethernet cable
4. Ensure NVMe drive is installed in M.2 slot
5. Power on device

**Validation (check each):**

1. **Kernel boots to console**
   - dmesg should scroll on HDMI
   - Eventually reach login prompt or Talos maintenance mode

2. **Device tree identification**
   ```
   cat /proc/device-tree/model
   ```
   Should show: "FriendlyElec NanoPi M6"

3. **Ethernet (CRITICAL)**
   ```
   ip link show eth0
   ```
   Should show eth0 interface (even if DOWN)

4. **USB host**
   ```
   lsusb
   ```
   Should list at least USB hubs, plus any connected devices

5. **NVMe (CRITICAL)**
   ```
   lsblk
   ```
   Should show nvme0n1 device

**Report results:**
- If ALL pass: Type "Phase 3 validated - all drivers working"
- If ANY fail: Describe which check failed and what output you see
  </how-to-verify>
  <resume-signal>
Type validation result:
- "Phase 3 validated - all drivers working" (all checks pass)
- Or describe failures with dmesg/output snippets
  </resume-signal>
</task>

<task type="auto">
  <name>Task 3: Record validation results</name>
  <files>docs/BOOT-TEST-CHECKLIST.md</files>
  <action>
Based on checkpoint results, update BOOT-TEST-CHECKLIST.md with Phase 3 attempt record:

```markdown
### Phase 3 Attempt #1

| Setting | Value |
|---------|-------|
| Date | YYYY-MM-DD |
| Image | Talos SBC kernel + DTB build |
| SD Card | [card details] |
| Result | [SUCCESS/PARTIAL/FAIL] |

#### Validation Results

| Check | Status | Notes |
|-------|--------|-------|
| Kernel boot | [PASS/FAIL] | [observed behavior] |
| Device tree ID | [PASS/FAIL] | [model string or error] |
| Ethernet (eth0) | [PASS/FAIL] | [ip link output] |
| USB host | [PASS/FAIL] | [lsusb output] |
| NVMe detection | [PASS/FAIL] | [lsblk output] |

#### dmesg snippets (relevant)
```
[paste relevant dmesg lines]
```

#### Issues Found
- [list any issues]

#### Next Steps
- [if SUCCESS: proceed to Phase 4]
- [if FAIL: identify gap closure needed]
```
  </action>
  <verify>
BOOT-TEST-CHECKLIST.md contains Phase 3 attempt with actual hardware results
  </verify>
  <done>
Phase 3 validation results documented with pass/fail status for each driver
  </done>
</task>

</tasks>

<verification>
- All critical drivers validated on hardware
- Results documented in BOOT-TEST-CHECKLIST.md
- Any failures identified for gap closure
</verification>

<success_criteria>
Phase 3 is COMPLETE when ALL of the following are TRUE:
1. Kernel boots and shows dmesg via HDMI
2. Device tree identifies board as NanoPi M6
3. Ethernet interface (eth0) exists
4. USB host controller initializes and enumerates devices
5. NVMe drive is detected (shows as nvme0n1)

If any criterion fails, gap closure plans will be needed.
</success_criteria>

<output>
After completion, create `.planning/phases/03-device-tree-kernel/03-04-SUMMARY.md`
</output>
