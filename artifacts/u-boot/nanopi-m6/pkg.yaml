name: u-boot-nanopi-m6
variant: scratch
shell: /toolchain/bin/bash
dependencies:
  - stage: rkbin
  - stage: u-boot-prepare
steps:
  - env:
      SOURCE_DATE_EPOCH: {{ .BUILD_ARG_SOURCE_DATE_EPOCH }}
      ROCKCHIP_TPL: /libs/rkbin/bin/rk35/rk3588_ddr_lp4_2112MHz_lp5_2400MHz_v1.18.bin
      BL31: /libs/rkbin/bin/rk35/rk3588_bl31_v1.48.elf
      # Attempt #4: Updated blobs to match Armbian (DDR v1.18, BL31 v1.48)
      CFLAGS: "-DCONFIG_LOG=y -DCONFIG_LOG_CONSOLE=y -DCONFIG_LOG_MAX_LEVEL=9"
    prepare:
      - |
        cd /src

        # Download NanoPi M6 defconfig from Armbian (tested, working configuration)
        # Armbian maintains this defconfig for U-Boot v2025.10 with native M6 support
        curl -fsSL -o configs/nanopi-m6-rk3588s_defconfig \
          "https://raw.githubusercontent.com/armbian/build/main/patch/u-boot/v2025.10/defconfig/nanopi-m6-rk3588s_defconfig"

        # Download NanoPi M6 device tree from Armbian
        # This DTS includes correct GPIO pins, PMIC config, ethernet, and LED definitions
        # U-Boot v2025.10 uses upstream DT location: dts/upstream/src/arm64/rockchip/
        curl -fsSL -o dts/upstream/src/arm64/rockchip/rk3588s-nanopi-m6.dts \
          "https://raw.githubusercontent.com/armbian/build/main/patch/u-boot/v2025.10/dt_upstream_rockchip/rk3588s-nanopi-m6.dts"

        # Use Armbian's M6 defconfig directly (no rock5a patching needed)
        make nanopi-m6-rk3588s_defconfig
    build:
      - |
        cd /src
        make -j $(nproc) HOSTLDLIBS_mkimage="-lssl -lcrypto"
    install:
      - |
        mkdir -p /rootfs/artifacts/arm64/u-boot/nanopi-m6
        cp -v /src/u-boot-rockchip.bin /rootfs/artifacts/arm64/u-boot/nanopi-m6
finalize:
  - from: /rootfs
    to: /rootfs
